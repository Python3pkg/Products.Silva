<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html tal:omit-tag=""
  lang="en"
  xml:lang="en"
  xmlns="http://www.w3.org/1999/xhtml"
  xmlns:metal="http://xml.zope.org/namespaces/metal"
  xmlns:notal="http://www.infrae.com/silva/notal"
  xmlns:tal="http://xml.zope.org/namespaces/tal"
  tal:define="
    global vein string:editor;
    refresh_time python:19 * 60;
    member python:here.service_members.get_member(here.REQUEST.AUTHENTICATED_USER.getUserName());
    editor python: member and member.editor() or 'field_editor';
    active_editor string:kupu;
  ">
<metal:block use-macro="here/macro_index/macros/master">
<metal:block fill-slot="metatype_css">
<link href="globals/widgetEditor.css"
  rel="stylesheet"
  tal:condition="python: editor != 'kupu' or model.meta_type != 'Silva Document'"
  tal:attributes="href string:${root_url}/globals/widgetEditor.css"
/>
<link href="kupustyles.css"
      type="text/css"
      rel="stylesheet"
      tal:condition="python:editor == 'kupu' and model.meta_type == 'Silva Document'"
/>
</metal:block>
<metal:block fill-slot="refresher">
  <tal:block define="rft refresh_time | python: 0">
    <tal:block condition="python: rft > 0">
      <tal:block condition="nothing"> Refresh code for session timeout </tal:block>
<noscript>
  <meta http-equiv="refresh" tal:attributes="content python:'%s, %s/edit/tab_preview' % (rft, request['model'].absolute_url())" />
</noscript>
<script language="JavaScript" 
  tal:define="destination_path string:${request/model/absolute_url}/edit/"
  tal:content="string:

  document.timeout = '${rft}'; 
  document.refresh_url = '${destination_path}tab_preview';
  document.prompt_url = '${destination_path}promptWindow';
" />
<script language="JavaScript" tal:condition="python:editor != 'kupu' or model.meta_type != 'Silva Document'">
  function handleTimeout()
  {
    if (document.promptWindow)
    {
      document.promptWindow.close();
    }
    loc = document.location.toString();
    editurl = loc.substring(0, loc.indexOf('/edit/'));
    document.location = document.refresh_url;
  }
  function setAutoSave(submit)
  {
    if (! document.autoSaveFormSubmit)
    {
      document.autoSaveFormSubmit = document.getElementById('default_submit');
      setTimeout('savePrompt()', document.timeout * 1000 / 4 * 3, '');
    }
  }
  function savePrompt()
  {
    leftPos = screen.width / 2 - 175;
    topPos = screen.height / 2 - 100;
    document.promptWindow = window.open(document.prompt_url, 'promptWindow', "height=175,width=300");
    document.promptWindow.focus();
  }
  function saveHelper()
  {
    document.autoSaveFormSubmit.click();
  }
  setTimeout('handleTimeout()', document.timeout * 1000, '');
</script>
    </tal:block>
  </tal:block>
</metal:block>

<metal:block metal:fill-slot="middleground">
  <div class="middleground"
    tal:define="active python: editor == 'kupu'">
    <tal:condition condition="python:model.meta_type == 'Silva Document' and hasattr(view, 'kupu')">
    <a title="edit with the kupu WYSIWYG editor: alt-("
      accesskey="("
      tal:content="python: test(active, 'kupu', ' kupu editor...')"
      tal:attributes="
        class python: test(active, 'selected', None);
        href python: '%s/edit?editor=kupu' % model.absolute_url()">
      </a>
    <div class="air"> </div>
    <a title="edit with the forms editor: alt-)"
      accesskey=")"
      tal:content="python: test(active, ' field editor...', 'field editor')"
      tal:attributes="
        class python: test(active, None, 'selected');
        href python: '%s/edit?editor=field_editor' % model.absolute_url()">
    </a>
    </tal:condition>
    <a title="see the content in the public layout: alt-;"
      accesskey=";"
      tal:attributes="href string:${model/absolute_url}/preview_html">
      public&nbsp;preview...
    </a>
  </div>
</metal:block>

<metal:block fill-slot="main"
  tal:define="
    is_locked model/sec_is_locked;
    unapproved_version model/get_unapproved_version;
    request_pending python:model.is_version_approval_requested();
">

<model tal:condition="python:(editor != 'kupu' or not hasattr(view, 'kupu') or model.meta_type != 'Silva Document') and unapproved_version and not request_pending and not is_locked" tal:omit-tag="">
  <tal:block tal:replace="structure view/edit">Content</tal:block>
</model>

<span tal:replace="nothing"> ______ kupu ______ </span>
<tal:block condition="python: editor == 'kupu' and hasattr(view, 'kupu') and model.meta_type == 'Silva Document' and unapproved_version and not request_pending and not is_locked">
  <tal:block define="kupumacros view/kupu/kupumacros/macros">

    <script type="text/javascript" src="kupu/sarissa"></script>
    <script type="text/javascript" src="kupu/kupuhelpers"></script>
    <script type="text/javascript" src="kupu/kupueditor"></script>
    <script type="text/javascript" src="kupu/kupubasetools"></script>
    <script type="text/javascript" src="kupu/kupuloggers"></script>
    <script type="text/javascript" src="kupu/kupucontentfilters"></script>
    <script type="text/javascript" src="kupu/kupucontextmenu"></script>
    <script type="text/javascript" src="kupu_silva/silva_kupu.js"></script>

    <script type="text/javascript">
	
	var kupu = null;
	var kupuui = null;
	function startKupu() {
	    var frame = document.getElementById('kupu-editor'); 
	    kupu = initSilvaKupu(frame); 
	    kupuui = kupu.getTool('ui'); 
	    kupu.initialize();
	};
	
    </script>

    <table width="100%" border="0" cellpadding="0" cellspacing="0">
    
    <tr>
    <td colspan="2">
      <div class="kupu-toolbar" id="toolbar" metal:use-macro="kupumacros/kupu_toolbar">
        <metal:slot fill-slot="tb_select_styles">
          <select id="kupu-tb-styles" onchange="kupuui.setTextStyle(this.options[this.selectedIndex].value)">
            <optgroup label="paragraph">
              <option value="P|normal">normal</option>
              <option value="P|lead">lead</option>
              <option value="P|annotation">annotation</option>
            </optgroup>
            <optgroup label="heading">
              <option value="H2">title</option>
              <option value="H3">normal</option>
              <option value="H4">sub</option>
              <option value="H5">subsub</option>
              <option value="H6">paragraph</option>
              <option value="H7">subparagraph</option>
            </optgroup>
            <option value="PRE">preformatted</option>
          </select>
        </metal:slot>
        <metal:slot fill-slot="buttongroup_color" />
        <metal:slot fill-slot="buttongroup_justify" />
        <metal:slot fill-slot="buttongroup_indent">
          <span class="kupu-tb-buttongroup">
            <button type="button" class="kupu-definitionlist" id="kupu-definitionlist-button" title="Definition List"
                    i18n:attributes="title" accesskey="d">&nbsp;</button>
          </span>
        </metal:slot>
        <metal:slot fill-slot="buttongroup_source" />
      </div>
    </td>
    </tr>

    <tr>
    <td width="100%" valign="top">
    <table metal:use-macro="kupumacros/kupu_colorchoosertable" />

    <div class="kupu-editorframe">
      <iframe id="kupu-editor" 
              frameborder="0" 
              src="kupu_content"
              dst=".."
              reloadsrc="1"
              usecss="0"
              charset="UTF-8"
              >
      </iframe>
    </div>
    </td>
    
    <td width="100%" valign="top">
    <metal:block use-macro="kupumacros/kupu_toolboxes">

      <div metal:fill-slot="kupu_toolbox_links">

        <div class="kupu-toolbox" id="kupu-toolbox-links">
          <script type="text/javascript">

            objLookupWindow = null;
            objTextArea = null;
            objReferenceFormat = null;
            objAppendValue = false;

            function openObjectLookupWindow(url_to_open) {
              // open the lookup window, will be called by getObjectReference

              width = 760;
              height = 500;
              leftPos = (screen.width - width) / 2;
              topPos = (screen.height - height) / 2;
              aspects = 'toolbar=yes,status=yes,scrollbars=yes,resizable=yes,width=' + width + ',height=' + height + ',left=' + leftPos + ',top=' + topPos;
              objLookupWindow = window.open(url_to_open, 'ObjectLookupWindow', aspects);
              objLookupWindow.focus();
            }

            function getObjectReference(url, format) {
              // should be called by pagetemplate
              referenceFormat = format;
              openObjectLookupWindow(url);
            }

            function insertObjectReference(id, reference, wndw) {
              // Is called by the window if the user selected an object
              var text = referenceFormat.replace('_id_', id).replace('_reference_', reference);
              var linktool = kupu.getTool('linktool');
              linktool.createLink(text);
              wndw.close();
            }

          </script>
          <script type="text/javascript" tal:define="container model/get_container" tal:content="string:
            function getLink() {
              getObjectReference('${container/absolute_url}/edit/document_lookup', '_reference_');
            }
          "></script>

          <h1>link</h1>

          <div id="kupu-toolbox-addlink"></div>
          <div id="kupu-toolbox-editlink"></div>
          <div class="kupu-tooltray">

            <form name="kupu_link_form" onsubmit="return false;">
              <input type="button" class="transport" style="margin-bottom:0.2em;" onclick="getLink(); return false;" value="get link reference..." />
              <input type="text" id="kupu-link-input" name="kupu_link_href" style="margin-left:0.2em; width:96%" />
              <input type="button" class="button" value="insert link" id="kupu-link-button" />
            </form>

          </div>
        </div>
      
        <div class="kupu-toolbox" id="kupu-toolbox-indexes">

          <h1>index item</h1>

          <div class="kupu-tooltray">

            <form name="kupu_index_form" onsubmit="return false;">
              <input type="text" id="kupu-index-input" name="kupu_index_href" style="margin-left:0.2em; width:96%" />
              <input type="button" class="button" value="insert index" id="kupu-index-button" />
            </form>

          </div>

        </div>

      </div>

      <div class="kupu-toolbox" id="kupu-toolbox-images" metal:fill-slot="kupu_toolbox_images">

        <script language="JavaScript">
        <!-- Asset Reference Lookup Window Opener

        lookupWindow = null;
        textArea = null;
        referenceFormat = null;
        appendValue = false;
        // Called from getAssetReference
        function openAssetLookupWindow(url_to_open) {
          // Do the opening
          width = 585;
          height = 300;
          leftPos = (screen.width - width) / 2;
          topPos = (screen.height - height) / 2;
          aspects = 'toolbar=yes,status=yes,scrollbars=yes,resizable=yes,width='+width+',height='+height+',left='+leftPos+',top='+topPos;
          lookupWindow = window.open(
            url_to_open, 'AssetLookupWindow', aspects);
          lookupWindow.focus();
        }
        // Called from "asset lookup window"
        function insertAssetReference(id, reference, wndw) {
          // for Kupu we need to place the image as well
          var imagetool = kupu.getTool('imagetool');
        
          imagetool.createImage(reference + '/image');
          // Close LookupWindow
          wndw.close();
        }
        //-->
        </script>
        <script type="text/javascript" tal:define="container model/get_container" tal:content="string:
          function getImage() {
            openAssetLookupWindow('${container/absolute_url}/edit/asset_lookup?filter=Silva+Image');
          }
        "></script>


        <h1>image</h1>

        <div class="kupu-tooltray">

          <form name="kupu_image_form">
            <input type="button" class="transport" onclick="getImage()" value="get image reference..." />
            <div id="kupu-toolbox-image-edit" style="color: black; display: none">
              <input type="text" id="kupu-toolbox-image-src" disabled="disabled" style="margin-left:0.2em; width:96%" />
              &nbsp;link to:<br />
              <input type="radio" id="kupu-toolbox-image-link-radio-hires" name="linkradio" value="hires" /> hires version<br />
              <input type="radio" id="kupu-toolbox-image-link-radio-link" name="linkradio" checked="checked" value="link" /> 
              <input type="text" id="kupu-toolbox-image-link" /><br />
              &nbsp;link target 
              <select id="kupu-toolbox-image-target" style="margin-left:0.2em">
                <option value="_self">same window</option>
                <option value="_blank">new window</option>
              </select><br />
              &nbsp;image alignment
              <select id="kupu-toolbox-image-align" style="margin-left:0.2em">
                <option value="left">left</option>
                <option value="middle">center</option>
                <option value="right">right</option>
              </select>
            </div>
          </form>

        </div>

      </div>

      <div class="kupu-toolbox" id="kupu-toolbox-tables" metal:fill-slot="kupu_toolbox_tables">
        <!-- start kupu toolbox tables -->
        
        <h1 i18n:translate="table-inspector">table</h1>

        <div class="kupu-tooltray">

        <table width="100%" style="color:black;" cellpadding="0">
          <tbody>
            <tr>
              <td>
                  <table width="100%" style="color: #333;">
                    <tr>
                      <td class="align-right" width="30%">table class</td>
                      <td>
                        <select class="manipulator" id="kupu-table-classchooser">
                          <option value="plain">plain</option>
                          <option value="list">list</option>
                          <option value="grid">grid</option>
                          <option value="datagrid">datagrid</option>
                        </select>
                      </td>
                    <tr>
                  </table>
              </td>
            </tr>
            <tr>
              <td colspan="2">
                <div id="kupu-toolbox-addtable">
                  <table width="100%" style="color: #333;">
                    <tr>
                      <td class="align-right" width="30%">rows</td>
                      <td><input id="kupu-table-newrows"/></td>
                    </tr>
                    <tr>
                      <td class="align-right">columns</td>
                      <td><input id="kupu-table-newcols"/></td>
                    </tr>
                    <tr>
                      <td class="align-right">heading</td>
                      <td>
                        <input id="kupu-table-makeheader" type="checkbox"/>
                          <label for="kupu-table-makeheader">create</label>
                      </td>
                    </tr>
                    <tr>
                      <td></td>
                      <td><button class="button" id="kupu-table-addtable-button">add</button></td>
                    </tr>
                  </table>
                </div>
                <div id="kupu-toolbox-edittable" style="display: none">
                  <table width="100%" style="color: black;">
                    <tr>
                      <td class="align-right" style="padding-right:0.3em" width="30%">column align</td>
                      <td>
                        <select class="manipulator" id="kupu-table-alignchooser">
                          <option value="left">left</option>
                          <option value="center">center</option>
                          <option value="right">right</option>
                          </select>
                      </td>
                    </tr>
                    <tr>
                      <td class="align-right">column</td>
                      <td>
                          <button class="button" id="kupu-table-addcolumn-button">add</button>
                          <button class="button" id="kupu-table-delcolumn-button">remove</button>
                      </td>
                    </tr>
                    <tr>
                      <td class="align-right">row</td>
                      <td>
                        <button class="button" id="kupu-table-addrow-button">add</button> 
                        <button class="button" id="kupu-table-delrow-button">remove</button></td>
                    </tr>
                    <tr>
                      <td class="align-right">cleanup cells</td>
                      <td>
                        <button class="button" id="kupu-table-fix-button">fix</button>
                      </td>
                  </table>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
        
        </div>

        <!-- end kupu toolbox tables -->
      </div>
      <!-- the following tool is disabled from CSS, at some point it should be removed using the fill-slot below -->
      <!-- <metal:block fill-slot="kupu_toolbox_debug" /> -->

      <div class="kupu-toolbox" id="kupu-toolbox-typochars" metal:fill-slot="extra_toolbox">

        <div class="kupu-toolbox" id="kupu-toolbox-toc">

          <h1>table of contents</h1>

          <div class="kupu-tooltray">

            <form name="kupu_index_form" onsubmit="return false;">
              <select id="kupu-toolbox-toc-depth">
                <option value="1">1 level</option>
                <option value="2">2 levels</option>
                <option value="3">3 levels</option>
                <option value="4">4 levels</option>
                <option value="5">5 levels</option>
                <option value="6">6 levels</option>
                <option value="7">7 levels</option>
                <option value="8">8 levels</option>
                <option value="9">9 levels</option>
                <option value="-1">unlimited</option>
              </select>
              <input class="button" type="button" value="add toc" id="kupu-toc-add-button" />
              <input class="warning" type="button" value="delete toc" id="kupu-toc-del-button" />
            </form>
            
          </div>

        </div>

        <div class="kupu-toolbox">
        
          <h1 i18n:translate="typographical-characters">typographical characters</h1>
          <div class="kupu-tooltray">
            &nbsp;&euro; &#145; &#146; &#147; &#148; &#171; &#187; &#8211; &#8212;
          </div>

        </div>

      </div>

    </metal:block>
    </td>
    </tr>

    </table>

  </tal:block>
</tal:block>

<span tal:replace="nothing"> _______ simultaneous edit lock _______ </span>
<tal:condition condition="python:unapproved_version and is_locked">
<form action="tab_edit_break_lock" method="POST">
  <div class="feedback"><span class="warning">
    <b>Note: </b>This object is already being edited by another user, and is temporarily locked.
    </span><br />
    <input class="warning" style="margin-left:0;" type="submit" value="break lock" title="Somebody else just edited this item, unlock it: alt-u" accesskey="u" />
  </div>
</form>
</tal:condition>

<span tal:replace="nothing"> _______ make changes in a new version _______ </span>
<tal:condition condition="python: not model.get_next_version()">
  <form action="tab_edit_make_copy" method="POST">
    <div class="feedback">
      <input class="button" style="margin-left:0;" type="submit" value="create new version" title="work on a new version while the previous one stays online: alt-c" accesskey="c" />
      <b>Note: </b>there is already a published (or closed) version of this content. Changes can only be made in a new version.
    </div>
  </form>
  <div tal:replace="structure here/edit_info | nothing" />
</tal:condition>

<span tal:replace="nothing"> _______ make changes after revoking approval _______ </span>
<tal:condition condition="python: model.get_approved_version()">
<form action="tab_edit_revoke_approval" method="POST">
  <div class="feedback">
    <input class="button" style="margin-left:0;" type="submit" value="revoke approval" title="'first un-approve' this item in order to edit: alt-r" accesskey="r" />
    <b>Note: </b>this version is approved but not yet public. In order to make changes you need to first revoke the approval.
  </div>
</form>
  <div tal:replace="structure here/edit_info | nothing" />
</tal:condition>

<span tal:replace="nothing"> _______ make changes after withdraw approval request _______ </span>
<tal:condition condition="python:model.is_version_approval_requested()">
<form action="tab_status_withdraw" method="POST">
  <div class="feedback">
    <input class="button" style="margin-left:0;" type="submit" value="withdraw request" title="withdraw a request for approval in order to edit: alt-w" accesskey="w" />
    <input type="hidden" name="rejection_status" tal:attributes="value python:test(may_approve_content, 'true', 'false')" />
    <input type="hidden" name="tab_name" value="edit" />
    <b>Note: </b>this version has an request for approval pending. In order to make changes you need to first withdraw the pending request.
  </div>
</form>
  <div tal:replace="structure here/edit_info | nothing" />
</tal:condition>

</metal:block>
</metal:block>
</html>

