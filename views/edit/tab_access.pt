<!-- _______________________ start index_html __________________________ -->
<tal:block define="global breadcrumb_vein string:Access;" />
<html metal:use-macro="here/macro_index/macros/master">
<div class="margins" metal:fill-slot="main">
<tal:block
  condition="python:view.has_access()"
  define="dummy python:model.security_trigger();">

<h2><img src="%s" width="16" height="16" alt="%s"
  tal:replace="structure python:view.render_icon(model.meta_type)" />&nbsp;
  Access Settings for <span class="folder-title" tal:content="structure string:&laquo;${model/get_title_html}&raquo;">title</span>
</h2>

<!-- div align="right">
<a href="tab_access?worksheet=overview">Access Overview</a>
</div -->
<div class="worksheet borders top bottom left right">
<!-- _________________________ START WORKSHEET _________________________ -->
<tal:block
  define="
    all_userinfos view/access_get_all_userinfos;
    global local_userinfos all_userinfos/local;
    global upward_userinfos all_userinfos/upward;" />
<!-- ______________________ USERS AND ROLES ____________________________ -->
<table width="100%" cellspacing="0" cellpadding="5" border="0">
<tr align="left" valign="top">
<!-- ___________________ Higher level UserRoles ________________________ -->
<td width="50%">
<form action="." method="POST">
<table width="100%" cellspacing="0" cellpadding="3" border="0">
<tr>
  <td colspan="3">
    <h3>Users with roles assigned on a higher level 
    <img src="pixel.gif" width="1px" height="14px"
      tal:attributes="src string:${silva_root}/globals/pixel.gif" />
    </h3>
  </td>
</tr>
<tr class="topcontrols">
  <td style="background:#c0dbe0;" align="left" colspan="2">
    Select checkboxes of users, select role, then assign a local role.
  </td>
</tr>
<tr class="focus"
  tal:condition="not:upward_userinfos">
  <td>
    <i>No users defined above</i>
  </td>
  <td>
    &nbsp;
  </td>
</tr>
<tal:block repeat="userinfo upward_userinfos">
<tr class="focus"
  tal:define="oddrow repeat/userinfo/odd"
  tal:attributes="class python:test(oddrow, 'focus', 'focus-cycle')">
  <td align="left" width="50%">
    <input type="checkbox" name="userids:list" value="userid"
      tal:attributes="value userinfo/uid" />
    <b tal:content="userinfo/cn" />
  </td>
  <td align="right" width="50%">
    <i>has role(s): </i>
    <b tal:repeat="role python:model.sec_get_upward_roles_for_userid(userinfo['uid'])"
      tal:content="role" />&nbsp;
  </td>
</tr>
</tal:block>
<tr class="controls-cycle">
  <td align="left" colspan="2">
    <select name="assign_role">
      <option value="None">Select role...</option>
      <option value="role"
        tal:repeat="role model/sec_get_roles"
        tal:attributes="value role"
        tal:content="role">Role name</option>
    </select>&nbsp;
    <input type="submit" class="button" name="access_assign_to_user:method" value="Assign local role"
      title="Assign a local role to selected user(s)." />
  </td>
</tr>
</table>
</form>
</td>
<!-- ____________________ Local level UserRoles ________________________ -->
<td>
<form action="." method="POST">
<table width="100%" cellspacing="0" cellpadding="3" border="0">
<tr>
  <td>
    <h3>Local users and roles
      <img src="pixel.gif" width="1px" height="14px"
        tal:attributes="src string:${silva_root}/globals/pixel.gif" />
    </h3>
  </td>
  <td colspan="2" align="right">
    <input type="hidden" name="referer" value="tab_access"/>
    <input type="submit" class="button" name="lookup:method" value="Users lookup..."
      title="Lookup and select users to add to groups... - alt-u" accesskey="u" />
  </td>
</tr>
<tr class="topcontrols">
  <td style="background:#b0cbd0;">
    Assign roles or remove local users.
  </td>
  <td style="background:#b0cbd0;" align="right" colspan="2">
    Revoke user's roles.
  </td>
</tr>
<tal:block repeat="userinfo local_userinfos">
<tal:block
  condition="userinfo"
  define="
    local_roles python:model.sec_get_local_roles_for_userid(userinfo['uid']);
    upward_roles python:model.sec_get_upward_roles_for_userid(userinfo['uid']);
    oddrow repeat/userinfo/odd">
<tr class="focus"
  tal:attributes="class python:test(oddrow, 'focus', 'focus-cycle')">
  <td align="left">
    <input type="checkbox" name="userids:list" value="userid"
      tal:attributes="value python:userinfo['uid']" />
    <b tal:content="python:userinfo['cn']" />
  </td>
  <td align="right">
    <i tal:condition="python:local_roles or upward_roles">has role(s):</i>
    <i tal:condition="python:not local_roles and not upward_roles">no&nbsp;roles&nbsp;defined</i>
  </td>
  <td align="right">
    &nbsp;
  </td>
</tr>
<tr class="focus-cycle"
  tal:repeat="role upward_roles"
  tal:attributes="class python:test(oddrow, 'focus', 'focus-cycle')">
  <td>
    &nbsp;
  </td>
  <td align="right">
    <b><i tal:content="role" /></b>
  </td>
  <td align="right">
    &nbsp;
  </td>
</tr>
<tr class="focus-cycle"
  tal:repeat="role local_roles"
  tal:attributes="class python:test(oddrow, 'focus', 'focus-cycle')">
  <td>
    &nbsp;
  </td>
  <td align="right">
    <b tal:content="role" />
  </td>
  <td align="right" width="1%">
    <input type="checkbox" class="warningbox" name="revoke_roles:list" value=""
      tal:attributes="value python:'%s||%s' % (userinfo['uid'], role);" />
  </td>
</tr>
</tal:block>
</tal:block>
<tr class="focus-cycle">
  <td>
    <i tal:condition="not:local_userinfos">No local user access defined</i>&nbsp;
  </td>
  <td align="right" colspan="2">
    <input type="submit" class="warningbutton" name="access_revoke_from_user:method" value="Revoke"
      title="Revoke selected role(s) from selected user(s)."
      tal:condition="local_userinfos" />
  </td>
</tr>
<tr class="controls">
  <td align="left" colspan="3">
    <select name="assign_role">
      <option value="None">Select role...</option>
      <option value="role"
        tal:repeat="role model/sec_get_roles"
        tal:attributes="value role"
        tal:content="role">Role name</option>
    </select>&nbsp;
    <input type="submit" class="button" name="access_assign_to_user:method" value="Assign"
      title="Assign a role to selected user(s)." />&nbsp; &nbsp;
    <input type="submit" class="button" name="access_remove_user:method" value="Remove"
      title="Remove this user from local access definitions."
      onClick="return confirm('Really remove user(s)?')" />
  </td>
</tr>
</table>
</form>
</td>
</tr>
</table>
<!-- _____________________ GROUPS AND ROLES ____________________________ -->
<br />
<div class="rule">&nbsp;</div>
<tal:block condition="python:model.sec_groups_enabled()">
<tal:block condition="python:not getattr(here, 'service_groups', None)">
<table width="100%" cellspacing="0" cellpadding="3" border="0">
<tr>
  <td>
    <h3>Groups</h3>
    <p>To actually use Group access definitions, a Groups Service is needed.<br />
      This service should have <code>service_groups</code> for its and be placed
      in the Silva Root.
    </p>
  </td>
</tr>
</table>
</tal:block>
<tal:block condition="python:getattr(here, 'service_groups', None)">
<tal:block
    define="
      all_groups view/access_get_all_groups;
      global local_groups all_groups/local;
      global upward_groups all_groups/upward;" />

<table width="100%" cellspacing="0" cellpadding="5" border="0">
<tr align="left" valign="top">
<!-- ___________________ Higher level GroupRoles _______________________ -->
<td width="50%">
<form action="." method="POST">
<table width="100%" cellspacing="0" cellpadding="3" border="0">
<tr>
  <td colspan="2">
    <h3>GroupRoles from a higher level down
      <img src="pixel.gif" width="1px" height="14px"
        tal:attributes="src string:${silva_root}/globals/pixel.gif" />
    </h3>
  </td>
</tr>
<tr class="topcontrols">
  <td style="background:#c0dbe0;" align="left" colspan="2">
    <img src="pixel.gif" width="1px" height="14px"
      tal:attributes="src string:${silva_root}/globals/pixel.gif" />
  </td>
</tr>
<tr class="focus"
  tal:condition="not:upward_groups">
  <td>
    <i>no groups defined</i>
  </td>
  <td>
    &nbsp;
  </td>
</tr>
<tal:block repeat="group upward_groups">
<tr class="focus"
  tal:define="oddrow repeat/group/odd"
  tal:attributes="class python:test(oddrow, 'focus', 'focus-cycle')">
  <td align="left" width="50%">
    <input type="checkbox" name="groups:list" value="group"
      tal:attributes="value group" />
    <b tal:content="group" />
  </td>
  <td align="right" width="50%">
    <i>has role(s): </i>
    <b tal:content="structure python:view.service_utils.frontend_render_list(model.sec_get_upward_roles_for_group(group))" />&nbsp;
  </td>
</tr>
</tal:block>
<tr class="controls-cycle">
  <td align="left" colspan="2">
    <select name="assign_role">
      <option value="None">Select role...</option>
      <option value="role"
        tal:repeat="role model/sec_get_roles"
        tal:attributes="value role"
        tal:content="role">Role name</option>
    </select>&nbsp;
    <input type="submit" class="button" name="access_assign_to_group:method" value="Assign local role"
      title="Assign selected role to selected group(s)." />
  </td>
</tr>
</table>
</form>
</td>
<!-- ___________________ Local level GroupRoles ________________________ -->
<td>
<form action="." method="POST">
<table width="100%" cellspacing="0" cellpadding="3" border="0">
<tr>
  <td>
    <h3>Local GroupRoles
      <img src="pixel.gif" width="1px" height="14px"
        tal:attributes="src string:${silva_root}/globals/pixel.gif" />
    </h3>
  </td>
  <td colspan="2" align="right">
    <input type="submit" class="button" name="tab_access_groups:method" value="Groups Admin..."
    title="Go to: Groups administration..." />
  </td>
</tr>
<tr class="topcontrols">
  <td style="background:#b0cbd0;" align="right" colspan="3">
    <img src="pixel.gif" width="1px" height="14px"
      tal:attributes="src string:${silva_root}/globals/pixel.gif" />
    <select name="add_group">
      <option value="None">Select group...</option>
      <option value="group"
        tal:repeat="group view/list_all_groups"
        tal:attributes="value group"
        tal:content="group">Group</option>
    </select>&nbsp;
    <input type="submit" class="button" name="group_add_to_selection:method" value="Use group"
    title="Add selected group to local access definitions." />
  </td>
</tr>
<tal:block repeat="group local_groups">
<tal:block
  condition="group"
  define="
    local_roles python:model.sec_get_local_roles_for_group(group);
    upward_roles python:model.sec_get_upward_roles_for_group(group);
    oddrow repeat/group/odd">
<tr class="focus"
  tal:attributes="class python:test(oddrow, 'focus', 'focus-cycle')">
  <td align="left">
    <input type="checkbox" name="groups:list" value="group"
      tal:attributes="value group" />
    <b tal:content="group" />
  </td>
  <td align="right">
    <i tal:condition="python:local_roles or upward_roles">has role(s):</i>
    <i tal:condition="python:not local_roles and not upward_roles">no&nbsp;roles&nbsp;defined</i>
  </td>
  <td align="right">
    &nbsp;
  </td>
</tr>
<tr class="focus-cycle"
  tal:attributes="class python:test(oddrow, 'focus', 'focus-cycle')"
  tal:repeat="role upward_roles">
  <td>
    &nbsp;
  </td>
  <td align="right">
    <b tal:content="role" />
  </td>
  <td align="right">
    &nbsp;
  </td>
</tr>
<tr class="focus-cycle"
  tal:attributes="class python:test(oddrow, 'focus', 'focus-cycle')"
  tal:repeat="role local_roles">
  <td>
    &nbsp;
  </td>
  <td align="right">
    <b tal:content="role" />
  </td>
  <td align="right" width="1%">
    <input type="checkbox" class="warningbox" name="revoke_roles:list" value=""
      tal:attributes="value python:'%s||%s' % (group, role);" />
  </td>
</tr>
</tal:block>
</tal:block>
<tr class="focus-cycle">
  <td>
    <i tal:condition="not:local_groups">No local group access defined</i>&nbsp;
  </td>
  <td align="right" colspan="2">
    <input type="submit" class="warningbutton" name="access_revoke_from_group:method" value="revoke"
      title="Revoke selected role(s) from selected group(s)."
      tal:condition="local_groups" />
  </td>
</tr>
<tr class="controls">
  <td align="left" colspan="3">
    <select name="assign_role">
      <option value="None">Select role...</option>
      <option value="role"
        tal:repeat="role model/sec_get_roles"
        tal:attributes="value role"
        tal:content="role">Role name</option>
    </select>&nbsp;
    <input type="submit" class="button" name="access_assign_to_group:method" value="Assign"
      title="Assign selected role to selected group(s)." />&nbsp; &nbsp;
    <input type="submit" class="button" name="access_remove_group:method" value="Remove"
      title="Remove selected group(s) from local access definitions."
      onClick="return confirm('Really remove group(s)?')" />
  </td>
</tr>
</table>
</form>
</td>
</tr>
</table>
</tal:block>
</tal:block>
<br />

<div class="rule">&nbsp;</div>
<table width="100%" cellspacing="0" cellpadding="3" border="0">
<tr>
  <td>
    <!-- ________________________ Mail users below ________________________ -->
    <table width="100%" cellspacing="0" cellpadding="3" border="0">
      <tr>
    <td>
          <h4>Mail users below this level</h4>
    </td>
      </tr>
      <tr>
        <td style="background:#c0dbe0;">
          Extract a list of email addressses of all users working in this area. 
         </td>
      </tr>
      <tr class="controls" align="right">
        <td>
	  <img src="pixel.gif" width="1px" height="14px"
	    tal:attributes="src string:${silva_root}/globals/pixel.gif" />
          <a class="buttonlink" href="tab_access_authorized_below" title="Fetch a list of email addresses... - alt-e" accesskey="e">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Extract email addresses...&nbsp;&nbsp;&nbsp;</a>
        </td>
      </tr>
    </table>

  </td>
</tr>
</table>
<!-- __________________________ END WORKSHEET __________________________ -->
</div>
<span class="halfline"><br /></span>
<h2><img src="%s" width="16" height="16" alt="%s"
    tal:replace="structure python:view.render_icon(model.meta_type)" />&nbsp;
    Access Restrictions for <span class="folder-title" tal:content="structure string:&laquo;${model/get_title_html}&raquo;">title</span>
</h2>
<div class="worksheet borders top bottom left right">
<table width="100%" cellspacing="0" cellpadding="5" border="0">
<tr align="left" valign="top">
<td>
<form action="minimal_access_role_submit" method="POST">
<table width="100%" cellspacing="0" cellpadding="3" border="0"
  tal:define="is_closed model/sec_is_closed_to_public">
  <tr>
    <td colspan="3">
      <h3>Access restriction by Role
        <img src="pixel.gif" width="1px" height="14px"
          tal:attributes="src string:${silva_root}/globals/pixel.gif" />
      </h3>
    </td>
  </tr>
  <tr>
    <td colspan="3" style="background:#c0dbe0;"
      tal:attributes="style python:test(is_closed > 1, 'background:#b0cbd0;;', 'background:#c0dbe0;;')">
      Setting an access restriction here affects all objects on this and lower levels.
    </td>
  </tr>
  <tr class="focus">
    <td valign="top">
        <p>
        Minimal role for viewing this object (and all children):
        <select name="role" tal:attributes="disabled python:test(model.sec_is_closed_to_public() > 1, 'disabled', '')">
          <option value="None" tal:attributes="selected python:test(not is_closed, 'SELECTED', '')">Unauthenticated</option>
          <option value="Viewer" tal:attributes="selected python:test(is_closed, 'SELECTED', '')">Viewer</option>
        </select>
        </p>
        <p tal:condition="python: is_closed > 1">
          This restriction is acquired from above and can be changed here:
          <a tal:attributes="href python:'%s/edit/tab_access' % view.REQUEST['URLPATH%s' % (is_closed + 1)]"
            tal:content="python: view.REQUEST['URLPATH%s' % (is_closed + 1)]">here</a>
        </p>
    </td>
  </tr>
  <tr class="controls" align="right">
    <td>
      <input class="button" type="submit" value="Set restriction" tal:attributes="disabled python:test(model.sec_is_closed_to_public() > 1, 'disabled', '')">
    </td>
  </tr>
</table>
</form>
</tr>
</table>

<!-- ___________________ Access restriction by IP address ________________________ -->
<table width="100%" cellspacing="0" cellpadding="5" border="0">
<tr align="left" valign="top">
<td>
<form action="access_restriction_submit" method="POST">
<table width="100%" cellspacing="0" cellpadding="3" border="0"
  tal:define="definition_aquired python:hasattr(model, 'access_restriction') and not model.hasProperty('access_restriction')">
<tr>
  <td colspan="3">
    <h3>Experimental: Define restriction by IP address
    <img src="pixel.gif" width="1px" height="14px"
      tal:attributes="src string:${silva_root}/globals/pixel.gif" />
    </h3>
  </td>
</tr>
<tr>
  <td colspan="3" style="background:#c0dbe0;"
    tal:attributes="style python:test(definition_aquired, 'background:#b0cbd0;;', 'background:#c0dbe0;;')">
    All objects on this and lower levels can be restricted for access from specific IP ranges.
  </td>
</tr>
<tr class="focus">
  <td>
    <p tal:condition="definition_aquired">
      This restriction is acquired from above: <code tal:content="python:getattr(model, 'access_restriction')" />
    </p>
    <p>
      <textarea name="access_restriction"
        tal:condition="python:model.hasProperty('access_restriction')"
        tal:content="python:model.getProperty('access_restriction')" />
      <textarea name="access_restriction"
        tal:condition="python:not model.hasProperty('access_restriction')">
      </textarea>
    </p>
  </td>
</tr>
<tr class="controls" align="right">
  <td>
    <input class="button" type="submit" value="Set restriction">
  </td>
</tr>
</table>
</form>
</tr>
</table>
</div>
</tal:block>
</div>
</html>
<!-- __________________________ end index_html _________________________ -->
