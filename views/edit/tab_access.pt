<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html tal:omit-tag=""
  lang="en"
  xml:lang="en"
  xmlns="http://www.w3.org/1999/xhtml"
  xmlns:metal="http://xml.zope.org/namespaces/metal"
  xmlns:notal="http://www.infrae.com/silva/notal"
  xmlns:tal="http://xml.zope.org/namespaces/tal"
  tal:define="global breadcrumb_vein string:Access;">
<metal:block use-macro="here/macro_index/macros/master">
<metal:block fill-slot="main">
  <table class="columns"
    tal:define="
      model_is_container model/implements_container | nothing;
      group_service view/service_groups | nothing;
      allow_subscription model/service_members/allow_subscription | nothing;"
    tal:condition="view/has_access">
    <tbody>
      <tal:block replace="nothing"> ________________ user roles management ________________ </tal:block>
      <tr>
        <tal:block replace="nothing">
          _____________________ sidebar subtable _____________________
        </tal:block>
        <td class="left" rowspan="99">
          <span tal:replace="structure python: view.service_sidebar.render(model, 'tab_access', breadcrumb_vein)" />
        </td>
        <td class="main">
          <tal:block replace="nothing">
            _____________________ main subtable _____________________
          </tal:block>
          <!-- Role assignment table -->
          <form action="."
            method="POST">
            <table class="listing"
              border="0"
              cellpadding="5"
              cellspacing="0"
              tal:define="members view/get_members">
              <thead>
                <tr>
                  <td class="top"
                    colspan="3">
                    <h2 tal:attributes="title string:id: ${model/id}">
                      <img tal:replace="structure python:view.render_icon(model)" />
                      user roles for
                      &#xab;<span tal:replace="structure string:${model/get_title_html}">
                        title
                      </span>&#xbb;
                    </h2>
                  </td>
                </tr>
              </thead>
              <tr class="top-controls">
                <td colspan="3">
                  <h3>
                    Grant or revoke local roles for users
                  </h3>
                </td>
              </tr>
              <tr class="align-left"
               >
                <th>
                  Username
                </th>
                <th class="align-right">
                  Roles defined above
                </th>
                <th class="align-right">
                  Roles defined here
                </th>
              </tr>
              <tal:block repeat="member members">
                <tr
                  tal:define="
                    iterate repeat/member/odd;
                    userid member/userid;
                    fullname member/fullname;"
                  tal:attributes="class python: iterate and 'odd' or 'even';">
                  <td class="align-left">
                    <input name="userids:list"
                      type="checkbox"
                      value="userid"
                      tal:attributes="
                        value userid;
                        id fullname;" />
                      &nbsp;
                      <label tal:content="fullname"
                        tal:attributes="for fullname">
                        username
                      </label>
                  </td>
                  <td class="align-right"
                    tal:define="upward_roles python:model.sec_get_upward_roles_for_userid(userid)">
                    <tal:block repeat="upward upward_roles">
                      <i tal:content="upward" /><br tal:condition="not:repeat/upward/end" />
                    </tal:block>
                  </td>
                  <td class="align-right">
                    <tal:block repeat="local python:model.sec_get_local_roles_for_userid(userid)">
                      <label tal:content="local" 
                        tal:attributes="for string:revoke_${userid}">
                        local
                      </label>
                      &nbsp;
                      <input class="warning-checkbox"
                        name="revoke_roles:list"
                        type="checkbox"
                        value=""
                        tal:attributes="
                          value python:'%s||%s' % (userid, local);
                          id string:revoke_${userid}" /><br tal:condition="not:repeat/local/end" />
                    </tal:block>
                  </td>
                </tr>
              </tal:block>
              <tr class="even"
                tal:condition="not:members">
                <td colspan="3">
                  <i>
                    No users with local roles
                  </i>
                </td>
              </tr>
              <tr class="controls">
                <td class="align-left"
                  colspan="2">
                  <tal:block tal:condition="members">
                    <select class="manipulator"
                      name="assign_role"
                      title="select a role to assign">
                      <option value="None">
                        select role:
                      </option>
                      <option value="role"
                        tal:repeat="role model/sec_get_roles"
                        tal:content="role"
                        tal:attributes="value role">
                        Role name
                      </option>
                    </select>
                    <input class="button"
                      name="access_assign_to_user:method"
                      title="assign a local role to selected user(s)"
                      type="submit"
                      value="Assign role" />
                  </tal:block>
                </td>
                <td class="align-right">
                  <input class="warning"
                    name="access_revoke_from_user:method"
                    title="revoke selected role(s) from selected user(s)"
                    type="submit"
                    value="Revoke role" 
                    tal:condition="members" />
                </td>
              </tr>
            </table>
          </form>
        <tal:block replace="nothing"> _________ pending roles management _________ </tal:block>
          <!-- Pending role requests -->
          <tal:block condition="allow_subscription">
            <form action="."
              method="POST">
              <table class="listing"
                border="0"
                cellpadding="5"
                cellspacing="0"
                style="empty-cells:show;"
                tal:define="requested_roles model/requested_roles">
                <tr class="top-controls">
                  <td colspan="3">
                    <h3>Pending requests for roles</h3>
                  </td>
                </tr>
                <tr tal:condition="requested_roles">
                  <th class="align-left">
                    Username
                  </th>
                  <th class="align-left">
                    Requested role
                  </th>
                  <th class="align-left">
                    Is approved
                  </th>
                </tr>
                <tal:block repeat="req requested_roles">
                  <tr tal:define="
                    iterate repeat/req/odd;
                    member python:model.sec_get_member(req[0]);
                    requested_role python:req[1];"
                    tal:attributes="class python: iterate and 'odd' or 'even';">
                    <td>
                      <input name="requests:list"
                        type="checkbox"
                        tal:attributes="
                          value python: '|'.join(req);
                          id string:pending_${member/userid};" />
                        <label tal:content="member/userid" 
                          tal:attributes="for string:pending_${member/userid}">
                          name
                        </label>
                    </td>
                    <td tal:content="requested_role">
                    </td>
                    <td tal:content="python: test(member.is_approved(), 'Yes', 'No')">
                      Yes or No
                    </td>
                  </tr>
                </tal:block>
                <tr class="even"
                  tal:condition="not:requested_roles">
                  <td colspan="3">
                    No roles requested
                  </td>
                </tr>
                <tr class="controls align-right">
                  <td>
                    <input class="warning"
                      name="tab_access_deny_access:method"
                      type="submit"
                      value="Deny role"
                      tal:condition="requested_roles" />
                  </td>
                  <td class="align-right"
                    colspan="2">
                    <tal:block tal:condition="requested_roles">
                      <input class="button"
                        name="tab_access_allow_access:method"
                        type="submit"
                        value="Grant role" />
                      <input class="button"
                        name="tab_access_allow_and_approve:method"
                        type="submit"
                        value="Grant and approve" />
                    </tal:block>
                  </td>
                </tr>
              </table>
            </form>
          </tal:block>
        </td>
        <td class="right">        
          <!-- Clipboard -->
          <metal:block use-macro="view/macro_user_lookup_clipboard/macros/clipboard">
            <div style="text-align:right;"
              metal:fill-slot="clipboard_actions">
              <select class="manipulator"
                name="assign_role"
                style="float:left;"
                title="select a role to assign">
                <option value="None">
                  select role:
                </option>
                <option value="role"
                  tal:repeat="role model/sec_get_roles"
                  tal:content="role"
                  tal:attributes="value role">
                  Role name
                </option>
              </select>
              <input class="button"
                name="access_assign_to_user:method"
                title="assign a local role to selected user(s)"
                type="submit"
                value="Assign" />
            </div>
          </metal:block>          
        </td>
      </tr>
      <tal:block replace="nothing"> ________________ group roles management ________________ </tal:block>
      <tr>
        <td class="main">
          <tal:block condition="python:model.sec_groups_enabled()">
            <div class="hilight borders top right bottom left"
              style="padding: 0.5em;"
              tal:condition="not:group_service">
              <div style="padding: 0em 2em 0em 2em;">
                <p class="warning"
                  style="font-size: 105%;">
                  <b>
                    Groups Service
                  </b>
                </p>
                <p>
                  You are seeing this message because the Silva Groups  
                  extension is installed but there's currently no Groups 
                  Service available. This service should have
                  <code>
                    service_groups
                  </code>
                  for its id and be placed in the Silva Root.
                </p>
              </div>
            </div>
            <tal:block condition="group_service">
              <!-- Defined groups listing -->
              <!-- Role assignment table -->
              <form action="."
                method="POST">
                <table class="listing"
                  border="0"
                  cellpadding="5"
                  cellspacing="0"
                  style="empty-cells:show;"
                  tal:define="groups view/get_groups;">
                  <thead>
                    <tr>
                      <td class="top"
                        colspan="3">
                        <h2 tal:attributes="title string:id: ${model/id}">
                          <img tal:replace="structure python:view.render_icon(model)" />
                          group roles for
                          &#xab;<span tal:replace="structure string:${model/get_title_html}">
                            title
                          </span>&#xbb;
                        </h2>
                      </td>
                    </tr>
                  </thead>
                  <tr class="top-controls">
                    <td colspan="3">
                      <h3>
                        Grant or revoke local roles for groups of users
                      </h3>
                    </td>
                  </tr>
                  <tr tal:condition="groups">
                    <th>
                      Groupname
                    </th>
                    <th class="align-right">
                      Roles defined above
                    </th>
                    <th class="align-right">
                      Roles defined here
                    </th>
                  </tr>
                  <tal:block repeat="ugroup groups">
                    <tr
                      tal:define="
                        group python: unicode(ugroup, 'latin1', 'ignore');
                        iterate repeat/ugroup/odd"
                      tal:attributes="class python: iterate and 'odd' or 'even';">
                      <td class="align-left">
                        <input name="groups:list"
                          type="checkbox"
                          value="group"
                          tal:attributes="
                            value group;
                            id group;" />
                          &nbsp;
                          <label tal:content="group"
                            tal:attributes="for group">
                            group
                          </label>
                          <tal:block 
                            condition="python: group not in group_service.listAllGroups()">
                            &lt;broken&gt; <!-- XXX replace this by something nice
                            -->
                          </tal:block>
                      </td>
                      <td class="align-right">
                        <tal:block repeat="upward python:model.sec_get_upward_roles_for_group(group)">
                          <i tal:content="upward" />
                          &nbsp;
                          <br tal:condition="not:repeat/upward/end" />
                        </tal:block>
                      </td>
                      <td class="align-right">
                        <tal:block repeat="local python:model.sec_get_local_roles_for_group(group)">
                          <label tal:content="local" 
                            tal:attributes="for string:revoke_${group}">
                            local
                          </label>
                          &nbsp;
                          <input class="warning-checkbox"
                            name="revoke_roles:list"
                            type="checkbox"
                            value=""
                            tal:attributes="
                              value python:'%s||%s' % (group, local);
                              id string:revoke_${group};" /><br tal:condition="not:repeat/local/end" />
                        </tal:block>
                      </td>
                    </tr>
                  </tal:block>
                  <tr class="even"
                    tal:condition="not:groups">
                    <td colspan="3">
                      No groups with (local) roles
                    </td>
                  </tr>
                  <tr class="controls">
                    <td class="align-left"
                      colspan="2">
                      <tal:block tal:condition="groups">
                        <select class="manipulator"
                          name="assign_role"
                          title="select a role to assign">
                          <option value="None">
                            select role:
                          </option>
                          <option value="role"
                            tal:repeat="role model/sec_get_roles"
                            tal:content="role"
                            tal:attributes="value role">
                            Role name
                          </option>
                        </select>
                        <input class="button"
                          name="access_assign_to_group:method"
                          title="assign a local role to selected user(s)"
                          type="submit"
                          value="Assign role to group" />
                      </tal:block>
                    </td>
                    <td class="align-right">
                      <input class="warning"
                        name="access_revoke_from_group:method"
                        title="revoke selected role(s) from selected group(s)"
                        type="submit"
                        value="Revoke role from group" 
                        tal:condition="groups" />
                    </td>
                  </tr>
                </table>
              </form>
            </tal:block>
          </tal:block>
        </td>
        <td class="right">
          <metal:block use-macro="view/macro_groups_listing/macros/all_groups_listing">
            <div style="text-align:right;"
              metal:fill-slot="listing_actions">
              <select class="manipulator"
                name="assign_role"
                style="float:left;"
                title="select a role to assign">
                <option value="None">
                  select role:
                </option>
                <option define="lastclass string:focus-cycle"
                  value="role"
                  tal:repeat="role model/sec_get_roles"
                  tal:content="role"
                  tal:attributes="value role">
                  Role name
                </option>
              </select>
              <input class="button"
                name="access_assign_to_group:method"
                title="assign selected role to selected group(s)"
                type="submit"
                value="Assign" />
          </div>
        </metal:block>        
        </td>
      </tr>
      <tal:block replace="nothing"> _______________________ misc tools _______________________ </tal:block>
      <tr>
        <td class="main">
            <tal:block replace="nothing"> _____________________ access restriction by role _____________________  </tal:block>
            <form action="minimal_access_role_submit"
              method="POST"
              tal:define="
                is_closed model/sec_is_closed_to_public;
                minimal_role model/sec_minimal_view_role;">
            <table class="listing">
              <thead>
                <tal:block replace="nothing"> ______________ vein + title row ______________ </tal:block>
                <tr>
                  <td class="top">
                    <h2 tal:attributes="title string:id: ${model/id}">
                      <img tal:replace="structure python:view.render_icon(model)" />
                      Public view access restrictions for &#xab;<span tal:replace="structure string:${title}">title</span>&#xbb;
                    </h2>
                  </td>
                </tr>
                <tal:block replace="nothing"> ______________ top controls row ______________ </tal:block>
                <tr class="top-controls">
                  <td>
                   <h3>
                     Access restriction by Role
                    </h3>
                  </td>
                </tr>
              </thead>
              <tbody>
                <tr class="odd">
                  <td>
                    Setting an access restriction here affects all objects on this and lower levels.
                  </td>
                </tr>
              </tbody>
              <tal:block replace="nothing"> ______________ controls ______________ </tal:block>
              <tfoot>
                <tr class="controls">
                  <td class="align-right">
                    <select class="manipulator"
                      name="role"
                      title="select a role to assign"
                      tal:attributes="disabled python:test(model.sec_is_closed_to_public() > 1, 'disabled', nothing)">
                      <option value="Anonymous"
                        tal:attributes="selected python:test(minimal_role == 'Anonymous', 'SELECTED', nothing)">
                        Anonymous
                      </option>
                      <option value="Viewer"
                        tal:attributes="selected python:test(minimal_role == 'Viewer', 'SELECTED', nothing)">
                        Viewer
                      </option>
                      <option value="Authenticated"
                        tal:attributes="selected python:test(minimal_role == 'Authenticated', 'SELECTED', nothing)">
                        Authenticated
                      </option>
                    </select>
                    <input class="button"
                      type="submit"
                      value="Set restriction"
                      title="restrict access to users with a specific role"
                      tal:attributes="disabled python:test(model.sec_is_closed_to_public() > 1, 'disabled', '')"
                     />
                  </td>
                </tr>
              </tfoot>
            </table>
          </form>
          <tal:block replace="nothing"> _____________________ access restriction IP address _____________________ </tal:block>
          <form action="access_restriction_submit"
            method="POST"
            tal:define="definition_aquired python:hasattr(model, 'access_restriction') and not model.hasProperty('access_restriction')">
            <table class="listing">
              <thead>
                <tr tal:replace="nothing">
                  ______________ top controls row ______________
                </tr>
                <tr class="top-controls">
                  <td colspan="2">
                    <h3>
                      Define restriction by IP address
                    </h3>
                  </td>
                </tr>
              </thead>
              <tbody>
                <tr class="odd">
                  <td>
                      All objects on this and lower levels can be restricted for access from specific IP ranges.
                      <span tal:omit-tag="" 
                        tal:condition="definition_aquired">
                        The current restriction (<code tal:content="python:getattr(model, 'access_restriction')" />) is acquired from above.
                      </span>
                  </td>
                </tr>
                <tr class="even">
                  <td>
                    <textarea name="access_restriction"
                      style="width:100%;"
                      tal:condition="python:model.hasProperty('access_restriction')"
                      tal:content="python:model.getProperty('access_restriction')"></textarea>
                    <textarea name="access_restriction"
                      style="width:100%;"
                      tal:condition="python:not model.hasProperty('access_restriction')"></textarea>
                  </td>
                </tr>
              </tbody>
              <tal:block replace="nothing"> ______________ controls ______________ </tal:block>
              <tfoot>
                <tr class="controls">
                  <td class="align-right">
                    <input class="button"
                      type="submit"
                      value="Set restriction"
                      title="restrict access to specified IP addresses" />
                  </td>
                </tr>
              </tfoot>
            </table>
          </form>
          <tal:block replace="nothing"> _____________________ utilities _____________________ </tal:block>
          <form action="minimal_access_role_submit"
            method="POST"
            tal:define="
              is_closed model/sec_is_closed_to_public;
              minimal_role model/sec_minimal_view_role;">
          <table class="listing sublisting"
            style>
            <thead>
              <tal:block replace="nothing"> ______________ vein + title row ______________ </tal:block>
              <tr>
                <td class="top">
                  <h2 tal:attributes="title string:id: ${model/id}">
                    <img tal:replace="structure python:view.render_icon(model)" />
                    utilities
                  </h2>
                </td>
              </tr>
              <tal:block replace="nothing"> ______________ top controls row ______________ </tal:block>
              <tr class="top-controls">
                <td>
                 <h3>
                   List user email addresses
                  </h3>
                </td>
              </tr>
            </thead>
            <tbody>
              <tr class="odd">
                <td>
                  List email addresses of all users from this level down.
                </td>
              </tr>
            </tbody>

            <tal:block replace="nothing"> ______________ controls ______________ </tal:block>
            <tfoot>
              <tr class="controls">
                <td class="align-right">
                  <a class="navigation"
                    href="tab_access_authorized_below"
                    title="retrieve a comma separated list of user email addresses">
                    &nbsp;List email addresses...
                  </a>
                </td>
              </tr>
            </tfoot>
          </table>
        </form>
        </td>
        <td class="right">
        </td>
      </tr>
    </tbody>
  </table>
</metal:block>
</metal:block>
</html>
