<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html tal:omit-tag=""
  lang="en"
  xml:lang="en"
  xmlns="http://www.w3.org/1999/xhtml"
  xmlns:metal="http://xml.zope.org/namespaces/metal"
  xmlns:tal="http://xml.zope.org/namespaces/tal"
  xmlns:i18n="http://xml.zope.org/namespaces/i18n"
  tal:define="global vein string:access;"
  i18n:domain="silva">

<metal:block use-macro="here/macro_index/macros/master">

  <metal:block metal:fill-slot="middleground">
    <tal:buttons tal:replace="structure model/@@tab_access_extra" />
  </metal:block>

<metal:block fill-slot="main"
  tal:define="
    model_is_container model/implements_container | nothing;
    allow_authentication_requests model/service_members/allow_authentication_requests | nothing;
    has_access here/has_change_access_permission;
    silva_permissions here/get_silva_permissions;
    i_am_manager silva_permissions/ChangeSilvaViewRegistry | nothing;
    managers_only_options python: ('Manager', 'ChiefEditor');
">

<table class="columns columns3"
  tal:condition="has_access">
  <tbody>
    <tr>
      <tal:block replace="nothing">
        __________________ sidebar _________________
      </tal:block>
      <td class="left" rowspan="99">
        <metal:use-macro use-macro="here/macro_vein_navigation/macros/vein">
          <metal:fill-slot fill-slot="sidebar">
            <tal:block replace="structure python: here.service_sidebar.render(model, 'tab_access', vein)" />
          </metal:fill-slot>
        </metal:use-macro>
      </td>
      <tal:block replace="nothing">
        __________________ main __________________
      </tal:block>
      <td class="main">
        <tal:block replace="nothing">
          ________________ user roles management ________________
        </tal:block>
        <form name="user_roles_management" action="."
          method="post"
          tal:define="
            members here/get_members;
            global revokeable_roles nothing">
          <table class="listing">
            <thead>
              <tr>
                <td class="top"
                  colspan="3">
                  <h2>
                    <img tal:replace="structure icon" />
                    <span i18n:translate="">user roles for</span> &#xab;<tal:block replace="title" />&#xbb;
                  </h2>
                </td>
              </tr>
              <tr class="top-controls">
                <td colspan="3">
                  <h3 i18n:translate="">
                    grant or revoke local roles for users
                  </h3>
                </td>
              </tr>
            </thead>
            <tbody>
              <tr class="align-left"
                tal:condition="members">
                <th i18n:translate="">
                  username
                </th>
                <th class="align-right" i18n:translate="">
                  roles defined above
                </th>
                <th class="align-right" i18n:translate="">
                  roles defined here
                </th>
              </tr>
              <tal:block repeat="member members">
                <tr tal:define="
                  iterate repeat/member/odd;
                  userid member/userid;
                  fullname member/fullname;"
                  tal:attributes="class python: iterate and 'odd' or 'even'">
                  <td class="align-left">
                    <input class="min"
                           type="checkbox"
                           name="userids:list"
                           tal:attributes="value userid;
                                           id fullname;"/>
                    <tal:icon
                       tal:replace="structure python:view.get_icon(member)" />
                    <label tal:content="fullname"
                           tal:attributes="for fullname">
                      username
                    </label>
                  </td>
                  <td class="align-right"
                    tal:define="upward_roles python:model.sec_get_upward_roles_for_userid(userid)">
                    <tal:block repeat="upward upward_roles">
                    <i i18n:translate="" tal:content="upward" /><br tal:condition="not:repeat/upward/end" />
                    </tal:block>
                  </td>
                  <td class="align-right">
                    <tal:block repeat="local python:model.sec_get_local_roles_for_userid(userid)">
                      <label tal:content="local"
                        tal:attributes="for string:revoke_${local}-${userid}"
                        i18n:translate="">
                        local
                      </label>
                        <input class="min"
                          type="checkbox"
                          name="revoke_roles:list"
                          tal:define="
                            global revokeable_roles python: 1;
                            enable python: i_am_manager or local not in managers_only_options;
                            disable not: enable;
                            "
                          tal:attributes="
                            value python:'%s||%s' % (userid, local);
                            id string:revoke_${local}-${userid};
                            disabled disable | nothing;
                            "
                          /><br tal:condition="not:repeat/local/end" />
                    </tal:block>
                  </td>
                </tr>
              </tal:block>
              <tr class="even"
                tal:condition="not:members">
                <td colspan="3">
                  <i i18n:translate="">
                    No users with local roles are defined here.
                  </i>
                </td>
              </tr>
              <tr class="controls">
                <td class="align-left"
                  colspan="2">
                  <tal:block condition="members"
                    define="preselected python: request.form.get('assign_role')">
                    <select class="manipulator"
                      style="float:left"
                      name="assign_role"
                      title="select a role to assign"
                      i18n:attributes="title">
                      <option value="None" i18n:translate="">
                        select role:
                      </option>
                      <metal:block use-macro="here/macro_role_options/macros/options" />
                    </select>
                    <input class="button"
                      style="float:left"
                      name="access_assign_to_user:method"
                      title="assign a local role to selected user(s)"
                      type="submit"
                      value="assign role"
                      i18n:attributes="title;value"
                    />
                  </tal:block>
                </td>
                <td class="align-right">
                  <input class="button remover"
                    name="access_revoke_from_user:method"
                    title="revoke selected role(s) from selected user(s)"
                    type="submit"
                    value="revoke role"
                    tal:condition="revokeable_roles"
                    i18n:attributes="title;value"
                  />
                </td>
              </tr>
            </tbody>
          </table>
        </form>
        <tal:block replace="nothing">
          ____________ pending roles management ____________
        </tal:block>
        <!-- Pending role request listing -->
        <tal:block condition="allow_authentication_requests">
          <form name="pending_roles_management" action="."
            method="post"
            tal:define="requested_roles model/requested_roles"
            tal:condition="requested_roles">
            <table class="listing"
              border="0"
              cellpadding="5"
              cellspacing="0"
              style="empty-cells:show;">
              <tr class="top-controls">
                <td colspan="3">
                  <h3 i18n:translate="">pending requests for roles</h3>
                </td>
              </tr>
              <tr>
                <th i18n:translate="">
                  username
                </th>
                <th i18n:translate="">
                  requested role
                </th>
                <th i18n:translate="">
                  is approved
                </th>
              </tr>
              <tal:block repeat="req requested_roles">
                <tr tal:define="
                  iterate repeat/req/odd;
                  member python:model.sec_get_member(req[0]);
                  requested_role python:req[1];"
                  tal:attributes="class python: iterate and 'odd' or 'even';">
                  <td>
                    <input class="min"
                      type="checkbox"
                      name="requests:list"
                      tal:attributes="
                        value python: '|'.join(req);
                        id string:pending_${member/userid};" />
                      <label tal:content="member/userid"
                        tal:attributes="for string:pending_${member/userid}">
                        name
                      </label>
                  </td>
                  <td i18n:translate="" tal:content="requested_role">
                  </td>
                  <!--XXX: More i18n trouble:-->
                  <td tal:content="python: member.is_approved() and 'Yes' or 'No'" >
                    yes or no
                  </td>
                </tr>
              </tal:block>
              <tal:block replace="nothing">
                <!-- shouldn't be needed, since the entire form is conditioned -->
              </tal:block>
              <tr class="even"
                tal:condition="not:requested_roles">
                <td colspan="3">
                  <i i18n:translate="">
                    No roles have been requested.
                  </i>
                </td>
              </tr>
              <tr class="controls align-right">
                <td>
                  <input class="button remover"
                    name="tab_access_deny_access:method"
                    type="submit"
                    value="deny role"
                    title="access key: alt-d"
                    accesskey="d"
                    i18n:attributes="title;value"
                  />
                </td>
                <td class="align-right"
                  colspan="2">
                  <tal:block tal:condition="requested_roles">
                    <input class="button"
                      name="tab_access_allow_access:method"
                      type="submit"
                      value="grant role"
                      title="access key: alt-g"
                      accesskey="g"
                      i18n:attributes="title;value"
                    />
                    <input class="button"
                      name="tab_access_allow_and_approve:method"
                      type="submit"
                      value="Grant and approve"
                      title="access key: alt-a"
                      accesskey="a"
                      i18n:attributes="title;value"
                    />
                  </tal:block>
                </td>
              </tr>
            </table>
          </form>
        </tal:block>
      </td>
      <td class="right">
        <tal:block replace="nothing">
          _______________ users clipboard ________________
        </tal:block>
        <metal:block use-macro="here/macro_user_lookup_clipboard/macros/clipboard">
          <metal:block fill-slot="clipboard_actions">
            <select class="manipulator"
              style="float:left"
              name="assign_role"
              title="select a role to assign">
              <option value="None"
                i18n:translate="">
                select role:
              </option>
              <tal:block
                define="
                  preselected python: request.form.get('assign_role')">
                <metal:block
                  use-macro="
                    here/macro_role_options/macros/options" />
              </tal:block>
            </select>
            <input class="button"
              style="float:left"
              name="access_assign_to_user:method"
              title="assign a local role to selected user(s)"
              type="submit"
              value="assign"
              i18n:attributes="title;value"
            />
          </metal:block>
        </metal:block>
      </td>
    </tr>
    <tal:block replace="nothing">
      _____________________ misc tools ______________________
    </tal:block>
    <tr>
      <tal:block replace="nothing">
        ___________ access restriction by role __________
      </tal:block>
      <td class="main"
        style="padding-top:2em;">
        <form name="access_restrict_by_role" action=".."
          method="post"
          tal:define="
            info model/@@get_viewer_role_info;
            acquired info/acquired;
            selected_role info/selected_role;
            ">
          <table class="listing">
            <thead>
              <tal:block replace="nothing">
                _____________ vein + title row ______________
              </tal:block>
              <tr>
                <td class="top"
                  colspan="2">
                  <h2 tal:attributes="title string:id: ${model/id}">
                    <img tal:replace="structure icon" />
                    <tal:block i18n:translate="">public view access restrictions for</tal:block>
                    &#xab;<span tal:replace="structure string:${title}">title</span>&#xbb;
                  </h2>
                </td>
              </tr>
              <tal:block replace="nothing">
                ______________ top controls row _____________
              </tal:block>
              <tr class="top-controls">
                <td colspan="2">
                  <h3 i18n:translate="">
                    access restriction by role
                  </h3>
                </td>
              </tr>
            </thead>
            <tbody>
              <tr>
                <th i18n:translate="">
                  current restriction
                </th>
                <th i18n:translate="">note</th>
              </tr>
              <tr class="even">
                <td>
                  <i>
                    <tal:block condition="info/is_public"
                    i18n:translate="">Open to the public</tal:block>
                    <tal:block condition="not: info/is_public"
                    i18n:translate=""
                    tal:content="selected_role">role</tal:block>
                    <tal:block i18n:translate=""
                     condition="info/acquired">(acquired).</tal:block>
                  </i>
                </td>
                <td i18n:translate="">
                  Setting an access restriction here affects objects on this and lower levels.
                </td>
              </tr>
            </tbody>
            <tal:block replace="nothing">
              __________________ controls ___________________
            </tal:block>
            <tfoot>
              <tr class="controls">
                <td colspan="2">
                  <select class="manipulator"
                    style="float:left"
                    name="role"
                    title="select a role to assign"
                    i18n:attributes="title">
                    <tal:block define="preselected selected_role">
                      <metal:plug use-macro="here/macro_role_options/macros/access_restriction_options" />
                    </tal:block>
                  </select>
                  <input class="button"
                    style="float:left"
                    type="submit"
                    name="@@minimum_role_submit:method"
                    value="set restriction"
                    title="restrict access to users with a specific role"
                    i18n:attributes="title;value"
                  />
                  <input class="button remover"
                    style="float:left"
                    type="submit"
                    name="@@acquire_minimum_role_submit:method"
                    value="acquire restriction"
                    title="cancel the access restriction at this level, making it inherit from above"
                    i18n:attributes="title;value"
                    tal:condition="not:acquired"
                  />
                </td>
              </tr>
            </tfoot>
          </table>
        </form>
      </td>
      <td class="right">
      </td>
    </tr>
  </tbody>
</table>

<table class="columns columns3"
  tal:condition="not:has_access">
  <tbody>
    <tr>
      <tal:block replace="nothing">
        __________________ sidebar _________________
      </tal:block>
      <td class="left" rowspan="99">
        <metal:use-macro use-macro="here/macro_vein_navigation/macros/vein">
          <metal:fill-slot fill-slot="sidebar">
            <tal:block replace="structure python: here.service_sidebar.render(model, 'tab_access', vein)" />
          </metal:fill-slot>
        </metal:use-macro>
      </td>
      <tal:block replace="nothing">
        __________________ main __________________
      </tal:block>
      <td class="main">
        <table class="listing"
            tal:define="info model/@@get_viewer_role_info;
                        selected_role info/selected_role">
          <thead>
            <tal:block replace="nothing">
              _____________ vein + title row ______________
            </tal:block>
            <tr>
              <td class="top"
                colspan="2">
                <h2 tal:attributes="title string:id: ${model/id}" i18n:translate="">
                    <img tal:replace="structure icon" i18n:name="icon" />
                  public view access restrictions for &#xab;<span tal:replace="structure string:${title}" i18n:name="title">title</span>&#xbb;
                </h2>
              </td>
            </tr>
            <tal:block replace="nothing">
              ______________ top controls row _____________
            </tal:block>
            <tr class="top-controls">
              <td colspan="2">
                <h3 i18n:translate="">
                  access restriction by role
                </h3>
              </td>
            </tr>
          </thead>
          <tbody>
            <tr>
              <th i18n:translate="">
                current restriction
              </th>
              <th i18n:translate="">
                note
              </th>
            </tr>
            <tr class="even">
              <td>
                <i>
                  <tal:block condition="info/is_public" i18n:translate="">Open to the public</tal:block>
                  <tal:block condition="not: info/is_public"
                    tal:content="selected_role">role</tal:block>
                  <tal:block condition="info/acquired" i18n:translate="">(acquired).</tal:block>
                </i>
              </td>
              <td i18n:translate="">
                An access restriction here affects objects on this and lower levels.
              </td>
            </tr>
          </tbody>
        </table>
      </td>
      <td class="right">
      </td>
    </tr>
  </tbody>
</table>

</metal:block>
</metal:block>
</html>

