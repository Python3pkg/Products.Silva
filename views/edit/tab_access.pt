<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html tal:omit-tag=""
  lang="en"
  xml:lang="en"
  xmlns="http://www.w3.org/1999/xhtml"
  xmlns:metal="http://xml.zope.org/namespaces/metal"
  xmlns:notal="http://www.infrae.com/silva/notal"
  xmlns:tal="http://xml.zope.org/namespaces/tal"
  xmlns:i18n="http://xml.zope.org/namespaces/i18n"
  tal:define="global vein string:access;"
  i18n:domain="silva">

<metal:block use-macro="here/macro_index/macros/master">
<metal:block fill-slot="main"
  tal:define="
    model_is_container model/implements_container | nothing;
    group_service view/service_groups | nothing;
    allow_authentication_requests model/service_members/allow_authentication_requests | nothing;
    has_access here/has_change_access_permission;
    silva_permissions here/get_silva_permissions;
    i_am_manager silva_permissions/ChangeSilvaViewRegistry | nothing;
    managers_only_options python: ('Manager', 'ChiefEditor');    
">

<table class="columns columns3"
  tal:condition="has_access">
  <tbody>
    <tr>
      <tal:block replace="nothing">
        __________________ sidebar _________________
      </tal:block>
      <td class="left" rowspan="99">
        <metal:use-macro use-macro="view/macro_vein_navigation/macros/vein">
          <metal:fill-slot fill-slot="sidebar">
            <tal:block replace="structure python: view.service_sidebar.render(model, 'tab_access', vein)" />
          </metal:fill-slot>
        </metal:use-macro>
      </td>
      <tal:block replace="nothing">
        __________________ main __________________
      </tal:block>
      <td class="main">
        <tal:block replace="nothing"> 
          ________________ user roles management ________________ 
        </tal:block>
        <form action="."
          method="POST"
          tal:define="
            members view/get_members;
            global revokeable_roles nothing;
            global revokeable_groups nothing">
          <table class="listing">
            <thead>
              <tr>
                <td class="top"
                  colspan="3">
                  <h2>
                    <img tal:replace="structure python:view.render_icon(model)" />
                    <span i18n:translate="">user roles for</span> &#xab;<tal:block replace="title">title</tal:block>&#xbb;
                  </h2>
                </td>
              </tr>
              <tr class="top-controls">
                <td colspan="3">
                  <h3 i18n:translate="">
                    grant or revoke local roles for users
                  </h3>
                </td>
              </tr>
            </thead>
            <tbody>
              <tr class="align-left"
                tal:condition="members">
                <th i18n:translate="">
                  username
                </th>
                <th class="align-right" i18n:translate="">
                  roles defined above
                </th>
                <th class="align-right" i18n:translate="">
                  roles defined here
                </th>
              </tr>
              <tal:block repeat="member members">
                <tr
                  tal:define="
                    iterate repeat/member/odd;
                    userid member/userid;
                    fullname member/fullname;"
                  tal:attributes="class python: iterate and 'odd' or 'even';">
                  <td class="align-left">
                    <input class="min"
                      type="checkbox"
                      name="userids:list"
                      tal:attributes="
                        value userid;
                        id fullname;" />
                      <label style="text-transform:none"
                        tal:content="fullname"
                        tal:attributes="for fullname">
                        username
                      </label>
                  </td>
                  <td class="align-right"
                    tal:define="upward_roles python:model.sec_get_upward_roles_for_userid(userid)">
                    <tal:block repeat="upward upward_roles">
                    <i i18n:translate="" tal:content="upward" /><br tal:condition="not:repeat/upward/end" />
                    </tal:block>
                  </td>
                  <td class="align-right">
                    <tal:block repeat="local python:model.sec_get_local_roles_for_userid(userid)">
                      <label style="text-transform:none"
                        i18n:translate=""
                        tal:content="local" 
                        tal:attributes="for string:revoke_${local}-${userid}">
                        local
                      </label>
                        <input class="min"
                          type="checkbox"
                          name="revoke_roles:list"
                          tal:define="
                            global revokeable_roles python: 1;
                            enable python: i_am_manager or local not in managers_only_options;
                            disable not: enable;
                            "
                          tal:attributes="
                            value python:'%s||%s' % (userid, local);
                            id string:revoke_${local}-${userid};
                            disabled disable | nothing;
                            " 
                          /><br tal:condition="not:repeat/local/end" />
                    </tal:block>
                  </td>
                </tr>
              </tal:block>
              <tr class="even"
                tal:condition="not:members">
                <td colspan="3">
                  <i i18n:translate="">
                    No users with local roles are defined here.
                  </i>
                </td>
              </tr>
              <tr class="controls">
                <td class="align-left"
                  colspan="2">
                  <tal:block
                    condition="members"
                    define="preselected python: request.form.get('assign_role')"
                    >
                    <select class="manipulator"
                      name="assign_role"
                      title="select a role to assign"
                      i18n:attributes="title">
                      <option value="None" i18n:translate="">
                        select role:
                      </option>
                      <metal:block use-macro="here/macro_role_options/macros/options" />
                    </select>
                    <input class="button"
                      name="access_assign_to_user:method"
                      title="assign a local role to selected user(s)"
                      type="submit"
                      value="assign role"
                      i18n:attributes="title;value"
                    />
                  </tal:block>
                </td>
                <td class="align-right">
                  <input class="warning"
                    name="access_revoke_from_user:method"
                    title="revoke selected role(s) from selected user(s)"
                    type="submit"
                    value="revoke role"
                    tal:condition="revokeable_roles"
                    i18n:attributes="title;value"
                  />
                </td>
              </tr>
            </tbody>
          </table>
        </form>
        <tal:block replace="nothing"> 
          ____________ pending roles management ____________
        </tal:block>
        <!-- Pending role request listing -->
        <tal:block condition="allow_authentication_requests">
          <form action="."
            method="POST"
            tal:define="requested_roles model/requested_roles"
            tal:condition="requested_roles">
            <table class="listing"
              border="0"
              cellpadding="5"
              cellspacing="0"
              style="empty-cells:show;">
              <tr class="top-controls">
                <td colspan="3">
                  <h3 i18n:translate="">pending requests for roles</h3>
                </td>
              </tr>
              <tr>
                <th i18n:translate="">
                  username
                </th>
                <th i18n:translate="">
                  requested role
                </th>
                <th i18n:translate="">
                  is approved
                </th>
              </tr>
              <tal:block repeat="req requested_roles">
                <tr tal:define="
                  iterate repeat/req/odd;
                  member python:model.sec_get_member(req[0]);
                  requested_role python:req[1];"
                  tal:attributes="class python: iterate and 'odd' or 'even';">
                  <td>
                    <input class="min"
                      type="checkbox"
                      name="requests:list"
                      tal:attributes="
                        value python: '|'.join(req);
                        id string:pending_${member/userid};" />
                      <label style="text-transform:none"
                        tal:content="member/userid" 
                        tal:attributes="for string:pending_${member/userid}">
                        name
                      </label>
                  </td>
                  <td i18n:translate="" tal:content="requested_role">
                  </td>
                  <!--XXX: More i18n trouble:-->
                  <td tal:content="python: member.is_approved() and 'Yes' or 'No'" >
                    yes or no
                  </td>
                </tr>
              </tal:block>
              <tal:block replace="nothing"> 
                <!-- shouldn't be needed, since the entire form is conditioned -->
              </tal:block>
              <tr class="even"
                tal:condition="not:requested_roles">
                <td colspan="3">
                  <i i18n:translate="">
                    No roles have been requested.
                  </i>
                </td>
              </tr>
              <tr class="controls align-right">
                <td>
                  <input class="warning"
                    name="tab_access_deny_access:method"
                    type="submit"
                    value="deny role"
                    title="access key: alt-d"
                    accesskey="d"
                    i18n:attributes="title;value;accesskey deny_role_accesskey"
                  />
                </td>
                <td class="align-right"
                  colspan="2">
                  <tal:block tal:condition="requested_roles">
                    <input class="button"
                      name="tab_access_allow_access:method"
                      type="submit"
                      value="grant role"
                      title="access key: alt-g"
                      accesskey="g"
                      i18n:attributes="title;value;accesskey grant_role_accesskey"
                    />
                    <input class="button"
                      name="tab_access_allow_and_approve:method"
                      type="submit"
                      value="Grant and approve"
                      title="access key: alt-a"
                      accesskey="a"
                      i18n:attributes="title;value;accesskey grant_and_approve_accesskey"
                    />
                  </tal:block>
                </td>
              </tr>
            </table>
          </form>
        </tal:block>
      </td>
      <td class="right">        
        <tal:block replace="nothing"> 
          _______________ users clipboard ________________
        </tal:block>
        <metal:block use-macro="view/macro_user_lookup_clipboard/macros/clipboard">
          <metal:block fill-slot="clipboard_actions">
            <select class="manipulator"
              name="assign_role"
              title="select a role to assign">
              <option value="None" 
                i18n:translate="">
                select role:
              </option>
              <tal:block 
                define="
                  preselected python: request.form.get('assign_role')">
                <metal:block 
                  use-macro="
                    here/macro_role_options/macros/options" />
              </tal:block>
            </select>
            <input class="button"
              name="access_assign_to_user:method"
              title="assign a local role to selected user(s)"
              type="submit"
              value="assign" 
              i18n:attributes="title;value"
            />
          </metal:block>
        </metal:block>          
      </td>
    </tr>
    <tal:block replace="nothing">
      _______________ group roles management ________________
    </tal:block>
    <tr tal:condition="python:model.sec_groups_enabled() or group_service">
      <td class="main"
        style="padding-top:2em;">
        <tal:block condition="python:model.sec_groups_enabled()">
          <div class="alert"
            style="margin-bottom:1em;"
            tal:condition="not:group_service">
              <span class="subhead">
                <span class="warning" i18n:translate="">A Groups Service is not installed</span>
              </span><br /><span i18n:translate="">
              You are seeing this message because the Silva Groups extension is installed on the file system, 
              but a Groups Service hasn't been added to this Silva instance. To install one, go to the 
              <a href="" class="underline" tal:attributes="href string:${root_url}/manage_services"
                tal:content="string:Silva Root in the ZMI"
                i18n:name="silva_root_in_the_ZMI" i18n:translate="">Silva Root in the ZMI</a>,
              choose &#8220;Groups Service&#8221; from the add list and give it the id 
              <code tal:content="string:service_groups" i18n:name="service_groups">service_groups</code>. 
              No further configuration is necessary.</span>
          </div>
          <tal:block condition="group_service">
            <!-- Defined groups listing -->
            <!-- Role assignment table -->
            <form action="."
              method="POST">
              <table class="listing"
                border="0"
                cellpadding="5"
                cellspacing="0"
                style="empty-cells:show;"
                tal:define="groups view/get_groups;">
                <thead>
                  <tr>
                    <td class="top"
                      colspan="3">
                      <h2 tal:attributes="title string:id: ${model/id}">
                        <img tal:replace="structure python:view.render_icon(model)" />
                        <span i18n:translate="" tal:omit-tag="">group roles</span>
                      </h2>
                    </td>
                  </tr>
                </thead>
                <tr class="top-controls">
                  <td colspan="3">
                    <h3 i18n:translate="">
                      grant or revoke local roles for groups
                    </h3>
                  </td>
                </tr>
                <tr tal:condition="groups">
                  <th i18n:translate="">
                    groupname
                  </th>
                  <th class="align-right" i18n:translate="">
                    roles defined above
                  </th>
                  <th class="align-right" i18n:translate="">
                    roles defined here
                  </th>
                </tr>
                <tal:block repeat="group groups">
                  <tr
                    tal:define="
                      iterate repeat/group/odd"
                    tal:attributes="class python: iterate and 'odd' or 'even';">
                    <td class="align-left">
                      <input class="min"
                        type="checkbox"
                        name="groups:list"
                        tal:attributes="
                          value group;
                          id group;" />
                        &nbsp;
                        <label style="text-transform:none"
                          tal:content="group"
                          tal:attributes="for group">
                          group
                        </label>
                        <tal:block 
                          condition="python: group not in group_service.listAllGroups()" i18n:translate="">
                          &lt;broken&gt; <!-- XXX replace this by something nice
                          -->
                        </tal:block>
                    </td>
                    <td class="align-right">
                      <tal:block repeat="upward python:model.sec_get_upward_roles_for_group(group)">
                        <i tal:content="upward" />
                        &nbsp;
                        <br tal:condition="not:repeat/upward/end" />
                      </tal:block>
                    </td>
                    <td class="align-right">
                      <tal:block repeat="local python:model.sec_get_local_roles_for_group(group)">
                        <label style="text-transform:none"
                          tal:content="local" 
                          tal:attributes="for string:revoke_${group}">
                          local
                        </label>
                        &nbsp;
                          <input class="min"
                            type="checkbox"
                            name="revoke_roles:list"
                            value=""
                            tal:define="
                              global revokeable_groups python: 1;
                              enable python: i_am_manager or local not in managers_only_options;
                              disable not: enable;
                              "
                            tal:attributes="
                              value python:'%s||%s' % (group, local);
                              id string:revoke_${group};
                              disabled disable | nothing;
                              "
                            /><br tal:condition="not:repeat/local/end" />
                      </tal:block>
                    </td>
                  </tr>
                </tal:block>
                <tr class="even"
                  tal:condition="not:groups">
                  <td colspan="3">
                    <i i18n:translate="">
                      No groups with (local) roles.
                    </i>
                  </td>
                </tr>
                <tr class="controls">
                  <td class="align-left"
                    colspan="2">
                    <tal:block 
                      define="preselected python: request.form.get('assign_group_role')"
                      condition="groups"                      
                      >
                      <select class="manipulator"
                        name="assign_group_role"
                        title="select a role to assign">
                        <option value="None"
                          i18n:translate="">
                          select role:
                        </option>
                        <metal:block use-macro="here/macro_role_options/macros/options" />
                      </select>
                      <input class="button"
                        name="access_assign_to_group:method"
                        title="assign a local role to selected user(s)"
                        type="submit"
                        value="assign role to group"
                        i18n:attributes="title;value"
                      />
                    </tal:block>
                  </td>
                  <td class="align-right">
                    <input class="warning"
                      name="access_revoke_from_group:method"
                      title="revoke selected role(s) from selected group(s)"
                      type="submit"
                      value="revoke role from group" 
                      tal:condition="revokeable_groups"
                      i18n:attributes="title;value"
                    />
                  </td>
                </tr>
              </table>
            </form>
          </tal:block>
        </tal:block>
      </td>
      <tal:block replace="nothing"> 
        _______________ groups clipboard ________________
      </tal:block>
      <td class="right"
        style="padding-top:2em ! important;">
        <tal:condition condition="group_service">
          <tal:define define="global group_meta_type string:Silva Group">
            <metal:block use-macro="view/macro_groups_listing/macros/all_groups_listing">
              <metal:block fill-slot="listing_actions">
                <select class="manipulator"
                  name="assign_group_role"
                  title="select a role to assign">
                  <option value="None"
                    i18n:translate="">
                    select role:
                  </option>
                  <tal:block 
                    define="
                      preselected python: request.form.get('assign_group_role')">
                    <metal:block 
                      use-macro="
                        here/macro_role_options/macros/options" />
                  </tal:block>
                </select>
                <input class="button"
                  type="submit"
                  name="access_assign_to_group:method"
                  value="assign"
                  title="assign selected role to selected group(s)"
                  i18n:attributes="title;value"
                />
              </metal:block>
            </metal:block>
          </tal:define>
        </tal:condition>
      </td>
    </tr>
    <tal:block replace="nothing"> 
      _____________________ misc tools ______________________
    </tal:block>
    <tr>
      <tal:block replace="nothing"> 
        ___________ access restriction by role __________
      </tal:block>
      <td class="main"
        style="padding-top:2em;">
        <form action="."
          method="POST"
          tal:define="
            info view/get_viewer_role_info; 
            acquired info/acquired;
            selected_role info/selected_role;
            "
          >
          <table class="listing sublisting">
            <thead>
              <tal:block replace="nothing"> 
                _____________ vein + title row ______________
              </tal:block>
              <tr>
                <td class="top"
                  colspan="2">
                  <h2 tal:attributes="title string:id: ${model/id}">
                    <img tal:replace="structure python:view.render_icon(model)" />
                    <span i18n:translate="" tal:omit-tag="">public view access restrictions for</span> 
                    &#xab;<span tal:replace="structure string:${title}">title</span>&#xbb;
                  </h2>
                </td>
              </tr>
              <tal:block replace="nothing"> 
                ______________ top controls row _____________
              </tal:block>
              <tr class="top-controls">
                <td colspan="2">
                  <h3 i18n:translate="">
                    access restriction by role
                  </h3>
                </td>
              </tr>
            </thead>
            <tbody>
              <tr>
                <th i18n:translate="">
                  current restriction
                </th>
                <th i18n:translate="">note</th>
              </tr>
              <tr class="even">
                <td>
                  <i>
                    <tal:block condition="info/is_public"
                    i18n:translate="">Open to the public</tal:block>
                    <tal:block condition="not: info/is_public"
                    i18n:translate=""
                    tal:content="selected_role">role</tal:block>
                    <tal:block i18n:translate="" 
                     condition="info/acquired">(acquired).</tal:block>
                  </i>
                </td>
                <td i18n:translate=""> 
                  Setting an access restriction here affects objects on this and lower levels.
                </td>
              </tr>
            </tbody>
            <tal:block replace="nothing"> 
              __________________ controls ___________________
            </tal:block>
            <tfoot>
              <tr class="controls">
                <td>
                  <input
                    class="cancel"
                    type="submit"
                    name="tab_access_acquire_minimum_role_submit:method"
                    value="acquire restriction"
                    title="cancel the access restriction at this level, making it inherit from above"
                    i18n:attributes="title;value"
                    tal:condition="not:acquired"
                  />
                </td>
                <td class="align-right">
                  <select 
                    class="manipulator"
                    name="role"
                    title="select a role to assign" 
                    i18n:attributes="title">
                    <tal:block define="preselected selected_role">
                      <metal:block 
                        use-macro="
                          here/macro_role_options/macros/access_restriction_options" />
                    </tal:block>                    
                  </select>
                  <input 
                    class="button"
                    type="submit"
                    name="tab_access_minimum_role_submit:method"
                    value="set restriction"
                    title="restrict access to users with a specific role"
                    i18n:attributes="title;value"
                  />
                </td>
              </tr>
            </tfoot>
          </table>
        </form>
        <tal:block replace="nothing"> 
          ____________________ utilities ____________________
          turned off because of ridulously expensive tree walking
        </tal:block>
        <table class="listing sublisting" tal:replace="nothing">
          <thead>
            <tal:block replace="nothing">
              ______________ vein + title row _______________
            </tal:block>
            <tr>
              <td class="top">
                <h2 tal:attributes="title string:id: ${model/id}">
                  <img tal:replace="structure python:view.render_icon(model)" />
                  <span i18n:translate="" tal:omit-tag="">utilities</span>
                </h2>
              </td>
            </tr>
            <tal:block replace="nothing">
              ______________ top controls row _______________
            </tal:block>
            <tr class="top-controls">
              <td>
                <h3 i18n:translate="">
                  list user email addresses
                </h3>
              </td>
            </tr>
          </thead>
          <tbody>
            <tr class="odd">
              <td i18n:translate="">
                List email addresses of all users from this level down.
              </td>
            </tr>
          </tbody>

          <tal:block replace="nothing">
            ___________________ controls ____________________
          </tal:block>
          <tfoot>
            <tr class="controls">
              <td class="align-right"
                style="padding-top:0.3em;padding-bottom:0.3em;">
                <a class="transport"
                  href="tab_access_authorized_below"
                  title="retrieve a comma separated list of user email addresses"
                  accesskey="e"
                  i18n:attributes="title;accesskey list_email_addresses_accesskey"
                  i18n:translate=""
                  >
                  &nbsp;list <u>e</u>mail addresses...
                </a>
              </td>
            </tr>
          </tfoot>
        </table>
      </td>
      <td class="right">
      </td>
    </tr>
  </tbody>
</table>

<table class="columns columns3"
  tal:condition="not:has_access">
  <tbody>
    <tr>
      <tal:block replace="nothing">
        __________________ sidebar _________________
      </tal:block>
      <td class="left" rowspan="99">
        <metal:use-macro use-macro="view/macro_vein_navigation/macros/vein">
          <metal:fill-slot fill-slot="sidebar">
            <tal:block replace="structure python: view.service_sidebar.render(model, 'tab_access', vein)" />
          </metal:fill-slot>
        </metal:use-macro>
      </td>
      <tal:block replace="nothing">
        __________________ main __________________
      </tal:block>
      <td class="main">
        <table class="listing"
            tal:define="info view/get_viewer_role_info;
                        selected_role info/selected_role">
          <thead>
            <tal:block replace="nothing"> 
              _____________ vein + title row ______________
            </tal:block>
            <tr>
              <td class="top"
                colspan="2">
                <h2 tal:attributes="title string:id: ${model/id}" i18n:translate="">
                  <img tal:replace="structure python:view.render_icon(model)" />
                  public view access restrictions for &#xab;<span tal:replace="structure string:${title}" i18n:name="title">title</span>&#xbb;
                </h2>
              </td>
            </tr>
            <tal:block replace="nothing"> 
              ______________ top controls row _____________
            </tal:block>
            <tr class="top-controls">
              <td colspan="2">
                <h3 i18n:translate="">
                  access restriction by role
                </h3>
              </td>
            </tr>
          </thead>
          <tbody>
            <tr>
              <th i18n:translate="">
                current restriction
              </th>
              <th i18n:translate="">
                note
              </th>
            </tr>
            <tr class="even">
              <td>
                <i>
                  <tal:block condition="info/is_public" i18n:translate="">Open to the public</tal:block>
                  <tal:block condition="not: info/is_public"
                    tal:content="selected_role">role</tal:block>
                  <tal:block condition="info/acquired" i18n:translate="">(acquired).</tal:block>
                </i>
              </td>
              <td i18n:translate=""> 
                An access restriction here affects objects on this and lower levels.
              </td>
            </tr>
          </tbody>
        </table>
      </td>
      <td class="right">
      </td>
    </tr>
  </tbody>
</table>

</metal:block>
</metal:block>
</html>
                    
