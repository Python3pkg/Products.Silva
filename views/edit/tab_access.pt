<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html tal:omit-tag=""
  lang="en"
  xml:lang="en"
  xmlns="http://www.w3.org/1999/xhtml"
  xmlns:metal="http://xml.zope.org/namespaces/metal"
  xmlns:notal="http://www.infrae.com/silva/notal"
  xmlns:tal="http://xml.zope.org/namespaces/tal"
  tal:define="global breadcrumb_vein string:Access;">
<metal:block use-macro="here/macro_index/macros/master">
<metal:block fill-slot="main">
  <table class="columns columns3"
    tal:define="
      model_is_container model/implements_container | nothing;
      group_service view/service_groups | nothing;
      allow_subscription model/service_members/allow_subscription | nothing;"
    tal:condition="view/has_access">
    <tbody>
      <tal:block replace="nothing">
        ________________ user roles management ________________
      </tal:block>
      <tr>
        <td class="left" rowspan="99"
          tal:condition="model_is_container">
          <span tal:replace="structure python: view.service_sidebar.render(model, 'tab_access', breadcrumb_vein)" />
        </td>
        <td class="main">
          <!-- Role assignment table -->
          <form action="."
            method="POST">
            <table class="listing"
              border="0"
              cellpadding="5"
              cellspacing="0"
              tal:define="members view/get_members">
              <thead>
                <tr>
                  <td class="top"
                    colspan="99">
                    <h2 tal:attributes="title string:id: ${model/id}">
                      <img tal:replace="structure python:view.render_icon(model)" />
                      &nbsp;User Roles Management for
                      &#xab;<span tal:replace="structure string:${model/get_title_html}">
                        title
                      </span>&#xbb;
                    </h2>
                  </td>
                </tr>
              </thead>
              <tr class="top-controls">
                <td colspan="99">
                  <h3>
                    Grant or revoke local roles 
                    for users
                  </h3>
                </td>
              </tr>
              <tr class="align-left"
                valign="top">
                <th>
                  Username
                </th>
                <th class="align-right">
                  Upward defined roles
                </th>
                <th class="align-right">
                  Local roles
                </th>
              </tr>
              <tal:block repeat="member members">
                <tr valign="top"
                  tal:define="
                    iterate repeat/member/odd;
                    userid member/userid;
                    fullname member/fullname;"
                  tal:attributes="class python: iterate and 'odd' or 'even';">
                  <td class="align-left">
                    <input name="userids:list"
                      type="checkbox"
                      value="userid"
                      tal:attributes="
                        value userid;
                        id fullname;" />
                      &nbsp;
                      <label tal:content="fullname"
                        tal:attributes="for fullname">
                        username
                      </label>
                  </td>
                  <td class="align-right"
                    tal:define="upward_roles python:model.sec_get_upward_roles_for_userid(userid)">
                    <tal:block repeat="upward upward_roles">
                      <i tal:content="upward" /><br tal:condition="not:repeat/upward/end" />
                    </tal:block>
                  </td>
                  <td class="align-right">
                    <tal:block repeat="local python:model.sec_get_local_roles_for_userid(userid)">
                      <label tal:content="local" 
                        tal:attributes="for string:revoke_${userid}">
                        local
                      </label>
                      &nbsp;
                      <input class="warning"
                        name="revoke_roles:list"
                        type="checkbox"
                        value=""
                        tal:attributes="
                          value python:'%s||%s' % (userid, local);
                          id string:revoke_${userid}" /><br tal:condition="not:repeat/local/end" />
                    </tal:block>
                  </td>
                </tr>
              </tal:block>
              <tr class="odd"
                tal:condition="not:members">
                <td colspan="3">
                  <i>
                    No users with (local) roles.
                  </i>
                </td>
              </tr>
              <tr class="controls">
                <td class="align-left"
                  colspan="2">
                  <tal:block tal:condition="members">
                    <select name="assign_role">
                      <option value="None">
                        Select role...
                      </option>
                      <option value="role"
                        tal:repeat="role model/sec_get_roles"
                        tal:content="role"
                        tal:attributes="value role">
                        Role name
                      </option>
                    </select>
                    &nbsp;
                    <input class="button"
                      name="access_assign_to_user:method"
                      title="Assign a local role to selected user(s)."
                      type="submit"
                      value="Assign role to user" />
                  </tal:block>
                </td>
                <td class="align-right">
                  <input class="warning"
                    name="access_revoke_from_user:method"
                    title="Revoke selected role(s) from selected user(s)."
                    type="submit"
                    value="Revoke role from user" 
                    tal:condition="members" />
                </td>
              </tr>
            </table>
          </form>
          <!-- Pending role requests -->
          <tal:block condition="allow_subscription">
            <form action="."
              method="POST">
              <table class="listing"
                border="0"
                cellpadding="5"
                cellspacing="0"
                style="empty-cells:show;"
                tal:define="requested_roles model/requested_roles">
                <tr class="top-controls">
                  <td colspan="99">
                    <h3>Pending requests for roles</h3>
                  </td>
                </tr>
                <tr>
                  <th class="align-left">
                    Username
                  </th>
                  <th class="align-left"
                    style="border-left: 1px solid black; border-right: 1px solid black;">
                    Requested role
                  </th>
                  <th class="align-left"
                    width="">
                    Is approved
                  </th>
                </tr>
                <tal:block repeat="req requested_roles">
                  <tr tal:define="
                    iterate repeat/req/odd;
                    member python:model.sec_get_member(req[0]);
                    requested_role python:req[1];"
                    tal:attributes="class python: iterate and 'odd' or 'even';">
                    <td style="border-left: 1px solid black; border-right: 1px solid black;"
                      valign="top">
                      <input name="requests:list"
                        type="checkbox"
                        tal:attributes="
                          value python: '|'.join(req);
                          id string:pending_${member/userid};" />
                        <label tal:content="member/userid" 
                          tal:attributes="for string:pending_${member/userid}">
                          name
                        </label>
                    </td>
                    <td style="border-left: 1px solid black; border-right: 1px solid black;"
                      tal:content="requested_role">
                    </td>
                    <td tal:content="python: test(member.is_approved(), 'Yes', 'No')">
                      Yes or No
                    </td>
                  </tr>
                </tal:block>
                <tr class="odd"
                  tal:condition="not:requested_roles">
                  <td colspan="3">
                    <i>
                      No roles requested
                    </i>
                  </td>
                </tr>
                <tr class="controls align-right">
                  <td>
                    <input class="warningbutton"
                      name="tab_access_deny_access:method"
                      type="submit"
                      value="Deny role"
                      tal:condition="requested_roles" />
                  </td>
                  <td class="align-right"
                    colspan="2">
                    <tal:block tal:condition="requested_roles">
                      <input class="button"
                        name="tab_access_allow_access:method"
                        type="submit"
                        value="Grant role" />
                      <input class="button"
                        name="tab_access_allow_and_approve:method"
                        type="submit"
                        value="Grant and approve" />
                    </tal:block>
                  </td>
                </tr>
              </table>
            </form>
          </tal:block>
        </td>
        <td class="right">
          <!-- Clipboard -->
          <metal:block use-macro="view/macro_user_lookup_clipboard/macros/clipboard">
            <metal:block fill-slot="clipboard_actions">
              <input class="button"
                style="float:right;"
                name="access_assign_to_user:method"
                title="Assign a local role to selected user(s)."
                type="submit"
                value="Assign" />
              <select name="assign_role">
                <option value="None">
                  Select role...
                </option>
                <option value="role"
                  tal:repeat="role model/sec_get_roles"
                  tal:content="role"
                  tal:attributes="value role">
                  Role name
                </option>
              </select>
              &nbsp;
            </metal:block>
          </metal:block>          
        </td>
      </tr>
      <tal:block replace="nothing">
        ________________ group roles management ________________
      </tal:block>
      <tr>
        <td class="main">
          <tal:block condition="python:model.sec_groups_enabled()">
            <div class="hilight borders top right bottom left"
              style="padding: 0.5em;"
              tal:condition="not:group_service">
              <div style="padding: 0em 2em 0em 2em;">
                <p class="warning"
                  style="font-size: 105%;">
                  <b>
                    Groups Service
                  </b>
                </p>
                <p>
                  You are seeing this message because the Silva Groups  
                  extension is installed but there's currently no Groups 
                  Service available. This service should have
                  <code>
                    service_groups
                  </code>
                  for its id and be placed in the Silva Root.
                </p>
              </div>
            </div>
            <tal:block condition="group_service">
              <!-- Defined groups listing -->
              <!-- Role assignment table -->
              <form action="."
                method="POST">
                <table class="listing"
                  border="0"
                  cellpadding="5"
                  cellspacing="0"
                  style="empty-cells:show;"
                  tal:define="groups view/get_groups;">
                  <thead>
                    <tr>
                      <td class="top"
                        colspan="99">
                        <h2 tal:attributes="title string:id: ${model/id}">
                          <img tal:replace="structure python:view.render_icon(model)" />
                          &nbsp;Group Roles Management for
                          &#xab;<span tal:replace="structure string:${model/get_title_html}">
                            title
                          </span>&#xbb;
                        </h2>
                      </td>
                    </tr>
                  </thead>
                  <tr class="top-controls">
                    <td colspan="99">
                      <h3>
                        Grant or revoke local roles for groups of users
                      </h3>
                    </td>
                  </tr>
                  <tr class="align-left"
                    valign="top">
                    <th>
                      Groupname
                    </th>
                    <th class="align-rigth"
                      style="border-left: 1px solid black; border-right: 1px solid black;">
                      Upward defined roles
                    </th>
                    <th class="align-right">
                      Local roles
                    </th>
                  </tr>
                  <tal:block repeat="ugroup groups">
                    <tr valign="top"
                      tal:define="
                        group python: unicode(ugroup, 'latin1', 'ignore');
                        iterate repeat/ugroup/odd"
                      tal:attributes="class python: iterate and 'odd' or 'even';">
                      <td class="align-left">
                        <input name="groups:list"
                          type="checkbox"
                          value="group"
                          tal:attributes="
                            value group;
                            id group;" />
                          &nbsp;
                          <label tal:content="group"
                            tal:attributes="for group">
                            group
                          </label>
                          <tal:block 
                            condition="python: group.encode('latin1') not in group_service.listAllGroups()">
                            &lt;broken&gt; <!-- XXX replace this by something nice
                            -->
                          </tal:block>
                      </td>
                      <td class="align-right"
                        style="border-left: 1px solid black; border-right: 1px solid black;">
                        <tal:block repeat="upward python:model.sec_get_upward_roles_for_group(group)">
                          <i tal:content="upward" />
                          &nbsp;
                          <br tal:condition="not:repeat/upward/end" />
                        </tal:block>
                      </td>
                      <td class="align-right">
                        <tal:block repeat="local python:model.sec_get_local_roles_for_group(group)">
                          <label tal:content="local" 
                            tal:attributes="for string:revoke_${group}">
                            local
                          </label>
                          &nbsp;
                          <input class="warning"
                            name="revoke_roles:list"
                            type="checkbox"
                            value=""
                            tal:attributes="
                              value python:'%s||%s' % (group, local);
                              id string:revoke_${group};" /><br tal:condition="not:repeat/local/end" />
                        </tal:block>
                      </td>
                    </tr>
                  </tal:block>
                  <tr class="odd"
                    tal:condition="not:groups">
                    <td colspan="3">
                      <i>
                        No groups with (local) roles
                      </i>
                    </td>
                  </tr>
                  <tr class="controls"
                    valign="top">
                    <td class="align-left"
                      colspan="2">
                      <tal:block tal:condition="groups">
                        <select name="assign_role">
                          <option value="None">
                            Select role...
                          </option>
                          <option value="role"
                            tal:repeat="role model/sec_get_roles"
                            tal:content="role"
                            tal:attributes="value role">
                            Role name
                          </option>
                        </select>
                        &nbsp;
                        <input class="button"
                          name="access_assign_to_group:method"
                          title="Assign a local role to selected user(s)."
                          type="submit"
                          value="Assign role to group" />
                      </tal:block>
                    </td>
                    <td class="align-right">
                      <input class="warning"
                        name="access_revoke_from_group:method"
                        title="Revoke selected role(s) from selected group(s)."
                        type="submit"
                        value="Revoke role from group" 
                        tal:condition="groups" />
                    </td>
                  </tr>
                </table>
              </form>
            </tal:block>
          </tal:block>
        </td>
        <td class="right">        
          <metal:block use-macro="view/macro_groups_listing/macros/all_groups_listing">
          <metal:block fill-slot="listing_actions">
            <input class="button"
              style="float:right;"
              name="access_assign_to_group:method"
              title="Assign selected role to selected group(s)."
              type="submit"
              value="Assign" />
            <select name="assign_role">
              <option value="None">
                Select role...
              </option>
              <option define="lastclass string:focus-cycle"
                value="role"
                tal:repeat="role model/sec_get_roles"
                tal:content="role"
                tal:attributes="value role">
                Role name
              </option>
            </select>
            &nbsp;
          </metal:block>
        </metal:block>        
        </td>
      </tr>
      <tal:block replace="nothing">
        ________________ misc tools ________________
      </tal:block>
      <tr>
        <td class="main">
          <h2>
            <img alt="%s"
              height="16"
              src="%s"
              width="16"
              tal:replace="structure python:view.render_icon(model)" />
            &nbsp; Public view access restrictions for
            <span class="folder-title"
              tal:content="
                structure string:&amp;#xab;${model/get_title_or_id_html}&amp;#xbb;">
              title
            </span>
          </h2>
          <div class="hilight borders top right bottom left"
            style="padding: 0.5em; margin: 0em 0em 2em 0em;">
            <form action="minimal_access_role_submit"
              method="POST">
              <table border="0"
                cellpadding="3"
                cellspacing="0"
                tal:define="
                  is_closed model/sec_is_closed_to_public;
                  minimal_role model/sec_minimal_view_role;">
                <tr class="align-left">
                  <td>
                    <b>
                      Access restriction by Role
                    </b>
                    <br />
                    <br />
                    Setting an access restriction here affects all objects on this and lower levels.
                  </td>
                </tr>
                <tr valign="top">
                  <td>
                    <select name="role"
                      tal:attributes="disabled python:test(model.sec_is_closed_to_public() > 1, 'disabled', nothing)">
                      <option value="Anonymous"
                        tal:attributes="selected python:test(minimal_role == 'Anonymous', 'SELECTED', nothing)">
                        Anonymous
                      </option>
                      <option value="Viewer"
                        tal:attributes="selected python:test(minimal_role == 'Viewer', 'SELECTED', nothing)">
                        Viewer
                      </option>
                      <option value="Authenticated"
                        tal:attributes="selected python:test(minimal_role == 'Authenticated', 'SELECTED', nothing)">
                        Authenticated
                      </option>
                    </select>
                    &nbsp;
                    <input class="button"
                      type="submit"
                      value="Set restriction"
                      title="Restrict access to users with a specific role"
                      tal:attributes="disabled python:test(model.sec_is_closed_to_public() > 1, 'disabled', '')" />
                  </td>
                </tr>
              </table>
            </form>
          </div>
          <div class="hilight borders top right bottom left"
            style="padding: 0.5em; margin: 0em 0em 2em 0em;">
            <form action="access_restriction_submit"
              method="POST">
              <table border="0"
                cellpadding="3"
                cellspacing="0"
                tal:define="definition_aquired python:hasattr(model, 'access_restriction') and not model.hasProperty('access_restriction')">
                <tr class="align-left">
                  <td>
                    <b>
                      Define restriction by IP address
                    </b>
                    <br />
                    <br />
                    All objects on this and lower levels can be restricted for access from specific IP ranges.
                    <p tal:condition="definition_aquired">
                      This restriction is acquired from above:
                      <code tal:content="python:getattr(model, 'access_restriction')" />
                    </p>
                  </td>
                </tr>
                <tr valign="top">
                  <td class="align-right">
                    <textarea name="access_restriction"
                      tal:condition="python:model.hasProperty('access_restriction')"
                      tal:content="python:model.getProperty('access_restriction')" />
                    <textarea name="access_restriction"
                      tal:condition="python:not model.hasProperty('access_restriction')">
                    </textarea>
                    <br />
                    <input class="button"
                      type="submit"
                      value="Set restriction"
                      title="Restrict access to specified IP addresses" />
                  </td>
                </tr>
              </table>
            </form>
          </div>
          <h2>
            <img alt="%s"
              height="16"
              src="%s"
              width="16"
              tal:replace="structure python:view.render_icon(model)" />
            &nbsp; Utilities
          </h2>
          <div class="hilight borders top right bottom left"
            style="padding: 0.5em; margin: 0em 0em 2em 0em; clear: both;">
            <table border="0"
              cellpadding="3"
              cellspacing="0">
              <tr class="align-left">
                <td>
                  <b>
                    List user email addresses
                  </b>
                  <br />
                  <br />
                  List email addresses of all users from this level down.
                </td>
              </tr>
              <tr valign="top">
                <td>
                  <a class="buttonlink"
                    href="tab_access_authorized_below"
                    title="Get a comma separated list of user email addresses">
                    List email addresses
                  </a>
                </td>
              </tr>
            </table>
          </div>          
        </td>
        <td class="right">
        </td>
      </tr>

    </tbody>
  </table>
</metal:block>
</metal:block>
</html>
