<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html metal:define-macro="master"
  lang="en"
  xml:lang="en"
  xmlns="http://www.w3.org/1999/xhtml"
  xmlns:metal="http://xml.zope.org/namespaces/metal"
  xmlns:tal="http://xml.zope.org/namespaces/tal"
  tal:define="
    view here;
    model request/model;
    trigger model/security_trigger;

    type model/meta_type;
    url model/absolute_url;
    title model/get_title_html;
    
    root_url model/get_root_url;

    containing_folder model/..;
    publication model/get_publication;
    containing_publication publication/../get_publication | publication;
    
    content_type view/set_content_type;
    set_cache_headers view/set_cache_headers;

    silva_permissions view/get_silva_permissions;
    may_approve_content silva_permissions/ApproveSilvaContent | nothing;
    may_change_content silva_permissions/ChangeSilvaContent | nothing;
    "
  >
<head>

<tal:block define="rft refresh_time | python: 0">
<tal:block condition="python: rft > 0">
<tal:block condition="nothing"> Refresh code for session timeout </tal:block>
<noscript>
  <meta http-equiv="refresh" tal:attributes="content python:'%s, %s/edit/tab_preview' % (rft, request['model'].absolute_url())" />
</noscript>
<script language="JavaScript" tal:content="string:

  document.timeout = '${rft}'; 
  document.refresh_url = '${request/model/absolute_url}/edit/tab_preview';
  document.prompt_url = '${view/get_root_url}/service_resources/Silva/promptwindow';

" />
<script language="JavaScript">

function handleTimeout()
{
  if (document.promptWindow)
  {
    document.promptWindow.close();
  }
  
  loc = document.location.toString();
  editurl = loc.substring(0, loc.indexOf('/edit/'));

  document.location = document.refresh_url;
}

function setAutoSave(submit)
{
  if (! document.autoSaveFormSubmit)
  {
    document.autoSaveFormSubmit = document.getElementById('default_submit');
    setTimeout('savePrompt()', document.timeout * 1000 / 4 * 3, '');
  }
}

function savePrompt()
{
  document.promptWindow = window.open(document.prompt_url, 'promptWindow');
}

function saveHelper()
{
  document.autoSaveFormSubmit.click();
}

setTimeout('handleTimeout()', document.timeout * 1000, '');

</script>
</tal:block>
</tal:block>
<title tal:content="structure title">
  Title
</title>
<link href="globals/favicon.ico"
  rel="shortcut icon"
  tal:attributes="href string:${root_url}/globals/favicon.ico"
/>
<!-- Plone Stylesheets -->
<style media="all"
  type="text/css"
  xml:space="preserve"
  tal:define="imports python: ['plone.css', 'ploneCustom.css',]"
  tal:content="structure python: view.css_imports(imports)"
>
@import url(globals/plone.css);
@import url(globals/ploneCustom.css);
</style>
<link href="globals/silva.css"
  rel="stylesheet"
  tal:attributes="href string:${root_url}/globals/silva.css"
/>
<link href="globals/silvaContentStyle.css"
  rel="stylesheet"
  tal:condition="python: not model.implements_container()"
  tal:attributes="href string:${root_url}/globals/silvaContentStyle.css"
/>
<link href="frontend.css"
  rel="stylesheet"
  tal:condition="python:template.id == 'tab_preview'"
  tal:attributes="href here/frontend.css/absolute_url | nothing"
/>
<!-- Plone Javascript -->
<script type="text/javascript"
  xml:space="preserve"
  tal:replace="nothing"
  tal:attributes="src string:${root_url}/globals/plone_javascripts.js"
>
</script>
<script language="JavaScript">

// can be attached to formfields so that pressing enter makes the form use
// a specific action, useful in forms with more than 1 submit button
function handle_default_action(element, event, action)
{
    code = event.which ? event.which : event.keyCode;
    if (code == 10 || code == 13)
    {
        element.form.action = action;
        element.form.submit();
    }
}

</script>
<script xml:space="preserve"
  tal:replace="nothing"
>
_______ application specific stylesheet extension _______
</script>
<link href="ext_stylesheet"
  rel="stylesheet"
  tal:condition="view/extension_style_url | nothing"
  tal:attributes="href view/extension_style_url"
/>
<style type="text/css"
  xml:space="preserve"
  tal:condition="python: template.id == 'tab_preview'"
>
div.workspace {background: #e6e6ee;}
</style>
<script xml:space="preserve"
  tal:replace="nothing"
>
_______ editor hooks _______
</script>
<script language="JavaScript"
  type="text/javascript"
  xml:space="preserve"
  tal:condition="python: template.id == 'tab_edit_bxe'"
  tal:attributes="src container/bxe/js/bitfluxeditor.js/absolute_url | nothing"
>
</script>
<script language="JavaScript"
  type="text/javascript"
  xml:space="preserve"
  tal:condition="python: template.id == 'tab_edit_xopus' and hasattr(container, 'xopus')"
  tal:attributes="src container/xopus/xopus/xopus.js/absolute_url | nothing"
/>
<span tal:replace="nothing"> _______ XXX Fixme: this needs to be absoluted _______ </span>
<script language="JavaScript"
  type="text/javascript"
  xml:space="preserve"
  tal:condition="python: template.id == 'tab_edit_eopro'"
  tal:content="structure python: template.tab_edit_eopro_js()"
/>
</head>
<body tal:attributes="onload python: test(template.id == 'tab_edit_bxe', 'BX_load(\'%s/bxe/bxe_config.xml\')' % url, 'if (window.focus_editor) window.focus_editor()')">

<tal:block replace="nothing">
  Previous onload tests facilitate Bitflux editor support
</tal:block>

<!-- ____________________________ start tabs ___________________________ -->
<metal:block use-macro="here/macro_tabs/macros/tabs">
  Tab bar plugs in here....
</metal:block>
<!-- ____________________________ end tabs _____________________________ -->
<span tal:replace="nothing">
<!-- _____________________ start workspace _____________________ -->
</span>
<div class="workspace">

<span tal:replace="nothing">
<!-- _______ start feedback _______ -->
</span>
<tal:block define="
  type options/message_type | request/message_type | nothing;
  msg options/message | request/message | nothing;"
  condition="type">
  <div class="feedback"
    style="margin-bottom:0;"
    tal:attributes="class python:type == 'feedback' and 'feedback' or 'alert'">
    <span tal:replace="structure msg">
      message
    </span>
    <span tal:replace="structure string:&nbsp;&nbsp;(${here/service_utils/backend_now_to_str})"
      tal:condition="python:type == 'feedback'">
      datetime
    </span>
  </div>
</tal:block>
<span tal:replace="nothing">
<!-- _______ end feedback _______ -->
</span>

<!-- ____________________________ main start ___________________________ -->
<div metal:define-slot="main">
  Here the local content (a.k.a. "model") is inserted (this text will be replaced).
</div>
<!-- ____________________________ main ends ____________________________ -->

<span tal:replace="nothing">
<!-- ______________ footer start ______________ -->
</span>
<span tal:replace="nothing">
<!-- _______ white space + jump to top _______ -->
</span>
<div>
  <div style="float: left;">
    <a href="#top"
      title="jump to top: alt-t"
    >
      <img alt="jump to top"
        border="0"
        height="16"
        width="16"
        tal:attributes="src string:${root_url}/globals/up_to_top_gray.gif"
      />
    </a>
  </div>
  <div style="float: right;">
    <a accesskey="t"
      href="#top"
      title="jump to top: alt-t"
    >
      <img alt="jump to top"
        border="0"
        height="16"
        width="16"
        tal:attributes="src string:${root_url}/globals/up_to_top_gray.gif"
      />
    </a>
  </div>
  &nbsp;
</div>

<span tal:replace="nothing">
<!-- _______ page info _______ -->
</span>
<div class="footer">
  <div style="float: left;">
    contact:
    <a shape="rect"
      tal:attributes="href python:'mailto:%s' % getattr(model, 'contact_email', None)"
    >
      <span tal:replace="model/contact_name | string:no name" />
    </a>
  </div>
  <div style="float: right;">
    <a shape="rect"
      title="Leave Silva and view the public page: alt-:"
      accesskey=":"
      tal:attributes="href url"
    >
      see public version
    </a>
  </div>
  <span tal:condition="python: getattr(model, 'contact_email', '') != ''"
    tal:omit-tag=""
  >
    email:
    <a tal:attributes="href python:'mailto:%s'% getattr(model, 'contact_email', nothing)">
      <span class="index-link"
        tal:content="model/contact_email | nothing"
      />
    </a>
  </span>
  &nbsp;
</div>

<span tal:replace="nothing">
<!-- _______ user tools _______ -->
</span>
<div class="personalBar"
  tal:define="userid request/AUTHENTICATED_USER/getUserName"
>
  <div style="float: left;">
    <a title="Change your settings: alt-~"
       accesskey="~"
      tal:attributes="
        onclick string:userWindow = window.open('service_resources/Silva/edit_member', 'userWindow', 'width=450, height=350, resizable=no');;
        userWindow.focus();;
        return false;;"
    >
      <img border="0"
        height="9"
        width="8"
        tal:attributes="src string:${root_url}/globals/user.gif"
      />
      user settings
    </a>
  </div>
  <div style="float: right;">
    <a accesskey="q"
      href="logout"
      title="Logout of Silva: alt-q"
    >
      logout
      <span tal:condition="here/get_user_role"
        tal:replace="
          structure string:${here/get_user_role}"
      />
      <span tal:replace="userid" />
    </a>
  </div>
  <a accesskey=","
    shape="rect"
    title="Request an additional role in this location: alt-,"
    tal:condition="python: hasattr(view, 'service_members') and view.service_members.allow_subscription()"
    tal:attributes="href string:public/request_roles?last_url=${url}"
  >
    request access
  </a>
  <a name="bottom">
    &nbsp;
  </a>
</div>
<span tal:replace="nothing">
<!-- ______________ footer ends ______________ -->
</span>

<span tal:replace="nothing">
<!-- _____________________ workspace ends _____________________ -->
</span>
</div>
 
<!-- served by <tal:block replace="string:(page served by ${request/HTTP_HOST})" /> -->

</body>
</html>
